<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="时间就是一个小偷,它让你猝不及防地失去,那些你很容易忽略掉的东西,当你记起时，却怎么也找不着了...">
<meta property="og:type" content="website">
<meta property="og:title" content="HuJian&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="HuJian&#39;s Blog">
<meta property="og:description" content="时间就是一个小偷,它让你猝不及防地失去,那些你很容易忽略掉的东西,当你记起时，却怎么也找不着了...">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HuJian&#39;s Blog">
<meta name="twitter:description" content="时间就是一个小偷,它让你猝不及防地失去,那些你很容易忽略掉的东西,当你记起时，却怎么也找不着了...">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>HuJian's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HuJian's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/14/react-native开发环境/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/14/react-native开发环境/" itemprop="url">react-native开发环境</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-14T23:43:09+08:00">
                2019-07-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/14/react-native开发环境/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/07/14/react-native开发环境/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="React-Native-Enviroment"><a href="#React-Native-Enviroment" class="headerlink" title="React Native Enviroment"></a>React Native Enviroment</h1><p>前面我们使用的开发方式是进化过的方式，简述步骤就是，先安装一个Expo应用程序，然后使用扫一扫功能在Expo内运行我们的App，偏向传统的前端开发方式。<br><br>这在之前，React Native采用的开发方式是先把写好的项目打包编译成一个独立App，然后直接安装到手机上运行，偏向传统的Native开发方式。</p>
<p><strong>环境预览</strong></p>
<ul>
<li>[参照文档] <a href="http://reactnative.cn/docs/0.42/getting-started.html" target="_blank" rel="noopener">http://reactnative.cn/docs/0.42/getting-started.html</a></li>
<li><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/environment_config.png?raw=true" alt="预览"></li>
</ul>
<hr>
<h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2><h3 id="Yarn与React-Native-Cli"><a href="#Yarn与React-Native-Cli" class="headerlink" title="Yarn与React-Native-Cli"></a><strong>Yarn与React-Native-Cli</strong></h3><p>Yarn是Facebook提供的替代npm的工具，可以加速node模块的下载。React Native的命令行工具用于执行创建、初始化、更新项目、运行打包服务（packager）等任务。<br></p>
<p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yarn react-native-cli</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检测</span></span><br><span class="line">yarn -v</span><br><span class="line">react-native -v</span><br></pre></td></tr></table></figure>
<p>镜像配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yarn config set registry https://registry.npm.taobao.org --global</span><br><span class="line">yarn config set disturl https://npm.taobao.org/dist --global</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检测</span></span><br><span class="line">yarn config get registry</span><br><span class="line">yarn config get disturl</span><br></pre></td></tr></table></figure>
<h3 id="Python2"><a href="#Python2" class="headerlink" title="Python2"></a><strong>Python2</strong></h3><p>需要注意，RN目前只支持<code>python2.x</code>版本，安装了3.x版本的需要更换。在安装python时，注意安装界面上的 <code>Add Python to path</code>选项, 勾选上会自动将Python配置到环境变量，否则需要手动配置。<br></p>
<ul>
<li><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/python.png?raw=true" alt="Add Python to path"></li>
<li>安装完毕后, 在命令行中键入 <code>python --version</code> 进行测试，显示出版本号即成功</li>
</ul>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a><strong>Java</strong></h3><p>如果使用Android系统开发测试，那么需要安装 Java SE Development Kit (JDK)，安装后需要手动配置环境变量。打开控制面板 -&gt; 系统和安全 -&gt; 系统 -&gt; 高级系统设置 -&gt; 高级 -&gt; 环境变量 -&gt; 新建。环境变量配置后，需要关闭现有的命令行工具然后重新打开，新的环境变量才会生效。</p>
<ul>
<li>[下载页面]<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a></li>
<li>[环境变量配置参考文档]<a href="https://jingyan.baidu.com/article/d45ad148ba5ab169552b80d3.html" target="_blank" rel="noopener">https://jingyan.baidu.com/article/d45ad148ba5ab169552b80d3.html</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 创建 JAVA_HOME 环境变量，值为 jdk 的安装根路径，默认 C:\Program Files\Java\jdk1.8.0_112</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 编辑 Path 环境变量，在 Path 中加入 %JAVA_HOME%\bin;%JAVA_HOME%\jre\bin，如果是Win10一个一个添加即可</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 创建 CLASSPATH 变量, 值为 .;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 配置完毕后保存并退出, 然后运行下面命令进行检测</span></span><br><span class="line">java -version</span><br><span class="line">javac -version</span><br></pre></td></tr></table></figure>
<h3 id="Android-Studio"><a href="#Android-Studio" class="headerlink" title="Android Studio"></a><strong>Android Studio</strong></h3><p>Android Studio是谷歌推出的Android集成开发工具，其包含了运行和测试React Native应用所需的Android SDK和模拟器。<br><br>在安装时需要确定所有安装都勾选了，尤其是Android SDK和Android Device Emulator。在初步安装完成后，选择Custom进行自定义安装。其中Androoid SDK Location目录可以选择一个剩余空间比较大的磁盘存放，建议至少留有10G。<br></p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h4><ul>
<li><img src="https://reactnative.cn/static/docs/0.51/img/react-native-android-studio-custom-install-windows.png" alt="Custom"></li>
<li><img src="https://reactnative.cn/static/docs/0.51/img/react-native-android-studio-verify-installs-windows.png" alt="setup"></li>
</ul>
<p>安装完成后，在Android Studio的欢迎界面中选择Configure | SDK Manager。</p>
<ul>
<li><img src="https://reactnative.cn/static/docs/0.51/img/react-native-android-studio-configure-sdk-windows.png" alt="welcome"></li>
</ul>
<p>在SDK Platforms窗口中，选择Show Package Details，然后在Android 6.0 (Marshmallow)中勾选Google APIs、Android SDK Platform 23、Intel x86 Atom System Image、Intel x86 Atom_64 System Image以及Google APIs Intel x86 Atom_64 System Image。</p>
<ul>
<li><img src="https://reactnative.cn/static/docs/0.51/img/react-native-android-studio-android-sdk-platforms-windows.png" alt="SDK platforms"></li>
</ul>
<p>在SDK Tools窗口中，选择Show Package Details，然后在Android SDK Build Tools中勾选Android SDK Build-Tools 23.0.1（必须包含有这个版本。当然如果其他插件需要其他版本，你可以同时安装其他多个版本）。然后还要勾选最底部的Android Support Repository.</p>
<ul>
<li><img src="https://reactnative.cn/static/docs/0.51/img/react-native-android-studio-android-sdk-build-tools-windows.png" alt="SDK tools"></li>
</ul>
<h4 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a><strong>配置环境变量</strong></h4><p>通过Android Studio安装的SDK路径，需要配置到ANDROID_HOME环境变量中。</p>
<p><img src="https://reactnative.cn/static/docs/0.51/img/react-native-android-sdk-environment-variable-windows.png" alt="ANDROID_HOME"></p>
<p>还可以把Android SDK的tools和platform-tools目录添加到PATH变量中，这样就可以在终端中运行一些Android工具，例如adb devices或android avd等。</p>
<p><img src="https://reactnative.cn/static/docs/0.51/img/react-native-android-tools-environment-variable-windows.png" alt="path"></p>
<h3 id="adb工具"><a href="#adb工具" class="headerlink" title="adb工具"></a>adb工具</h3><p>adb安装在Android-sdk路径下的platform-tools目录，这个工具是电脑与Android设备进行通信的通用命令行工具，有几个常用命令需要了解，将来打包调试的时候需要保证本机的adb版本需要与模拟器的adb一致，如果不一致可以复制本机的adb.ext然后覆盖掉模拟器中的版本。</p>
<ul>
<li>adb version        # 版本</li>
<li>adb devices        # 列出连接到本机的Android设备与状态</li>
<li>adb start-server  # 启动adb服务</li>
<li>adb kill-server    # 关闭adb服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb version</span><br><span class="line">// 第一行显示的信息：Android Debug Bridge version 1.0.40</span><br><span class="line">// 其中40就代表adb的版本，将来可能把copy这个版本的adb工具覆盖掉模拟器版本</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="开发方式"><a href="#开发方式" class="headerlink" title="开发方式"></a><strong>开发方式</strong></h2><h3 id="启动模拟器"><a href="#启动模拟器" class="headerlink" title="启动模拟器"></a>启动模拟器</h3><ul>
<li>启动模拟器，运行adb devices命令，查看设备是否正常连接，</li>
<li>如果提示adb版本不符合，那么就需要把本地Android-sdk目录下的adb.ext复制到模拟器目录下的bin中，进行覆盖。然后重启模拟器进行尝试。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 连接正常的话会显示设备信息或地址信息，如：127.0.0.1:62001 device</span><br><span class="line">adb devices</span><br><span class="line"></span><br><span class="line">// 如果没有发现设备，那么需要手动进行连接，夜神模拟器端口62001，MUMU模拟器端口7555</span><br><span class="line">adb connect 127.0.0.1:7555</span><br></pre></td></tr></table></figure>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>创建项目的时候，保证项目所在目录没有中文与空格，然后运行命令创建项目，创建的过程中需要联网下载依赖包，需要耐心等待。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建项目，项目名称自由定义</span></span><br><span class="line">react-native init projectName</span><br></pre></td></tr></table></figure>
<h3 id="启动js打包服务"><a href="#启动js打包服务" class="headerlink" title="启动js打包服务"></a>启动js打包服务</h3><ul>
<li>在项目目录下运行<code>yarn start</code>命令，默认会启动一个<code>8081</code>端口的js打包传输服务，它的作用是向移动设备提供项目最新的打包生成的bundle.js文件，每当代码变更时，该服务就会重新打包js并推送给客户端使用。</li>
<li><strong>注意</strong>：因为8081端口已经被adb工具占用了，所以我们需要手动换一个端口好。</li>
</ul>
<p><strong>端口检测</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 查看8081端口占用情况与pid</span><br><span class="line">netstat -aon | findstr 8081</span><br><span class="line"></span><br><span class="line">// 通过pid查阅程序名称，即可知道是谁占用了8081端口</span><br><span class="line">tasklist | findstr 上条命令得到的pid</span><br></pre></td></tr></table></figure>
<p><strong>启动服务</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 切入项目目录</span><br><span class="line">cd projectName</span><br><span class="line"></span><br><span class="line">// 启动服务，并指定端口</span><br><span class="line">yarn start --prot 8888</span><br></pre></td></tr></table></figure>
<p><strong>服务检测</strong></p>
<p>服务启动之后，我们可以通过浏览器测试js是否可以正常得到，url如下：<br><code>http://192.168.12.1:9999/index.bundle?platform=android</code></p>
<h3 id="app安装与运行"><a href="#app安装与运行" class="headerlink" title="app安装与运行"></a>app安装与运行</h3><ul>
<li>在项目目录下运行<code>react-native run-android</code>命令便会打包<code>android</code>项目, 生成<code>apk</code>文件, 然后自动安装到Android设备并运行。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">react-native run-android</span><br><span class="line">// 最后看到BUILD SUCCESSFUL提示就代表打包成功</span><br></pre></td></tr></table></figure>
<p>接下来设备会自动启动应用，如果显示如下界面就代表一切正常可以开发调试了。<br><br><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/react_welcome.png?raw=true" alt="成功运行"></p>
<p>打包中途打包失败了，记得看提示信息，可能是网络问题，一般会提示timed out，那么重拾或者找个网络环境好的，手机热点也可以。</p>
<p><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/bundle_error_timeout.jpg?raw=true" alt="timed out"></p>
<p>也可能会提示找不到android-sdk目录，那么需要手动创建一个配置文件放置到projectName/android/local.properties。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 配置sdk所在目录</span><br><span class="line">sdk.dir=G:\\Android-sdk</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="开发初体验"><a href="#开发初体验" class="headerlink" title="开发初体验"></a>开发初体验</h2><ul>
<li>在项目根目录下有个 <code>index.js</code> , 它是项目的<code>入口</code>文件, 负责注册根组件</li>
<li>根目录下有个 <code>App.js</code> , 是默认生成的<code>根组件</code>, 我们在 APP 上看到的<code>欢迎界面</code>就是这个组件实现的</li>
<li>尝试修改 <code>App.js</code> 中的文本内容, 然后手机摇一摇 <code>Reload</code> 查看即可看到修改内容</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;Text style=&#123;styles.welcome&#125;&gt;</span><br><span class="line">          你是我的了!</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Text style=&#123;styles.instructions&#125;&gt;</span></span><br><span class="line"><span class="regexp">          哈哈, 开心不?</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Text&gt;</span><br><span class="line">        &lt;Text style=&#123;styles.instructions&#125;&gt;</span><br><span class="line">          &#123;instructions&#125;</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>View&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>根组件代码解读</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导包</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Platform,</span><br><span class="line">  StyleSheet,</span><br><span class="line">  Text,</span><br><span class="line">  View</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Platform.select方法会根据运行环境得到配置的内容</span></span><br><span class="line"><span class="keyword">const</span> instructions = Platform.select(&#123;</span><br><span class="line">  ios: <span class="string">'Press Cmd+R to reload,\n'</span> +</span><br><span class="line">    <span class="string">'Cmd+D or shake for dev menu'</span>,</span><br><span class="line">  android: <span class="string">'Double tap R on your keyboard to reload,\n'</span> +</span><br><span class="line">    <span class="string">'Shake or press menu button for dev menu'</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出根组件, 组件的定于语法与之前学习的一样</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">// 返回的视图需要使用View组件包裹, 作用相当于Div标签</span></span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line"></span><br><span class="line">  		&#123;<span class="comment">/* 文本内容使用Text组件包裹, 作用相当于P标签 */</span>&#125;</span><br><span class="line">        &lt;Text style=&#123;styles.welcome&#125;&gt;</span><br><span class="line">          Welcome to React Native!</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Text style=&#123;styles.instructions&#125;&gt;</span></span><br><span class="line"><span class="regexp">          To get started, edit App.js</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Text&gt;</span><br><span class="line">        &lt;Text style=&#123;styles.instructions&#125;&gt;</span><br><span class="line">          &#123;instructions&#125;</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      &lt;/</span>View&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义样式, 这里的尺寸大小无需加单位, 元素可以通过数组引用多个样式, 后面的样式优先级比前面的高</span></span><br><span class="line"><span class="keyword">const</span> styles = StyleSheet.create(&#123;</span><br><span class="line">  container: &#123;</span><br><span class="line">    flex: <span class="number">1</span>,</span><br><span class="line">    justifyContent: <span class="string">'center'</span>,</span><br><span class="line">    alignItems: <span class="string">'center'</span>,</span><br><span class="line">    backgroundColor: <span class="string">'#F5FCFF'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  welcome: &#123;</span><br><span class="line">    fontSize: <span class="number">20</span>,</span><br><span class="line">    textAlign: <span class="string">'center'</span>,</span><br><span class="line">    margin: <span class="number">10</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  instructions: &#123;</span><br><span class="line">    textAlign: <span class="string">'center'</span>,</span><br><span class="line">    color: <span class="string">'#333333'</span>,</span><br><span class="line">    marginBottom: <span class="number">5</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="真机调试"><a href="#真机调试" class="headerlink" title="真机调试"></a>真机调试</h2><h3 id="app手动安装"><a href="#app手动安装" class="headerlink" title="app手动安装"></a>app手动安装</h3><ul>
<li>打包后的 <code>apk</code> 安装包, 可以在项目中找到，路径为 <code>projecrName/android/app/build/outputs/apk</code>，这个apk安装包可以手动安装到其它模拟器或真机中进行开发调试。</li>
<li>如果自动安装失败, 可自行把apk文件拷贝到手机存储器, 然后手动安装。</li>
</ul>
<h3 id="app权限设置"><a href="#app权限设置" class="headerlink" title="app权限设置"></a>app权限设置</h3><ul>
<li>app运行时需要<code>悬浮框</code>权限，可在<code>设置</code> =&gt; <code>授权管理</code> =&gt; <code>应用权限管理</code> 中找到对应的 APP , 然后<code>开启</code>悬浮框权限。<br></li>
</ul>
<h3 id="连接方式"><a href="#连接方式" class="headerlink" title="连接方式"></a>连接方式</h3><p>手机直连</p>
<ul>
<li>准备一台Android手机, 通过数据线连接到电脑，设置启用USB调试</li>
<li>一般的手机在设置中可以直接找到开发者选项进行开启, 部分手机开启的位置可能不同，根据需要自行百度一下</li>
<li>手机连接成功后运行检测命令adb devices,如果有输出设备列表与ID相关的字符串就证明连接成功了</li>
<li>附录: 小米手机开启USB调试步骤<ul>
<li>首先进入<code>设置</code> =&gt; <code>我的设备</code> =&gt; <code>全部参数</code> =&gt; 连续<code>点击</code>MUI版本3次以上</li>
<li>然后重新进入<code>设置</code> =&gt; <code>更多设置</code> =&gt; <code>开发者选项</code>(在无障碍下面) =&gt; 找到<code>USB调试</code>点击开启</li>
<li>最后需要拉到底部找到<code>启用 MUI 优化</code>, 关掉重启</li>
</ul>
</li>
</ul>
<p><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/usb_debug.png?raw=true" alt="usb调试"></p>
<p>局域网连接</p>
<ul>
<li>移动设备除了通过 <code>USB</code> 直连电脑调试开发, 还可以采用<code>无线</code>的方式进行调试</li>
<li>只要保证手机和电脑在同一个<code>局域网</code>, 然后摇一摇唤出调试菜单</li>
<li>点击 <code>Dev settings</code> =&gt; <code>Debuug server host</code> , 配置本地 <code>IP</code> 地址和端口号 <code>8081</code> 即可</li>
<li>如果出现这个<code>错误</code>提示, 说明配置错了: <code>could not connect to development server</code></li>
<li><img src="img/react_debug_server.png" alt="摇一摇弹出框"></li>
</ul>
<hr>
<h2 id="旧版环境安装，备份保留"><a href="#旧版环境安装，备份保留" class="headerlink" title="旧版环境安装，备份保留"></a>旧版环境安装，备份保留</h2><h3 id="注册事项"><a href="#注册事项" class="headerlink" title="注册事项"></a><strong>注册事项</strong></h3><ul>
<li>安装的目录结构中<code>不要</code>出现<code>中文</code>与<code>特殊字符</code></li>
<li>如果<code>计算机</code>名称是中文改成<code>英文</code></li>
<li>因为这些环境都依赖我们的操作系统，如果系统是被优化阉割的版本可能会安装失败</li>
</ul>
<h3 id="环境预览"><a href="#环境预览" class="headerlink" title="环境预览"></a><strong>环境预览</strong></h3><ul>
<li>参照文档 <a href="http://reactnative.cn/docs/0.42/getting-started.html" target="_blank" rel="noopener">http://reactnative.cn/docs/0.42/getting-started.html</a></li>
<li><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/environment_config.png?raw=true" alt="预览"></li>
</ul>
<h3 id="Node环境"><a href="#Node环境" class="headerlink" title="Node环境"></a><strong>Node环境</strong></h3><ul>
<li>下载最新的长期<code>稳定版本</code><a href="https://nodejs.org/en/" target="_blank" rel="noopener">https://nodejs.org/en/</a></li>
<li>安装完毕后，在命令行中键入 <code>node -v</code> 进行测试，显示出版本号即成功</li>
<li>在国内的话如有需要可以<code>修改</code> npm 的<code>下载地址</code>, 或在下载包的时候临时指定<ul>
<li><code>npm config set registry https://registry.npm.taobao.org -g</code></li>
<li><code>npm config set disturl https://npm.taobao.org/dist -g</code></li>
</ul>
</li>
</ul>
<h3 id="React-Native-Cli与Yarn"><a href="#React-Native-Cli与Yarn" class="headerlink" title="React-Native-Cli与Yarn"></a><strong>React-Native-Cli与Yarn</strong></h3><ul>
<li><code>Yarn</code> 是 <code>Facebook</code> 推出的<code>包管理</code>工具, 可以加速 node 模块的下载, <code>React-Native</code> 脚手架安装包的时候会使用</li>
<li><code>React-Native-Cli</code> 是一款命令行工具, 用于 <code>React-Native</code> 项目的创建、初始化、更新、运行与打包</li>
<li>安装命令: <code>npm install yarn react-native-cli -g</code></li>
<li>测试命令: <code>yarn -v</code> <code>react-native -v</code></li>
<li>安装完毕后可以设置 <code>Yarn</code> 安装模块的<code>镜像</code>地址<ul>
<li><code>yarn config set registry https://registry.npm.taobao.org -g</code></li>
<li><code>yarn config set disturl https://npm.taobao.org/dist -g</code></li>
</ul>
</li>
</ul>
<h3 id="Python环境"><a href="#Python环境" class="headerlink" title="Python环境"></a><strong>Python环境</strong></h3><ul>
<li>安装 <code>2.×</code> 的版本的 <code>python</code>, 安装时注意勾选安装界面上的 <code>Add Python to path</code>, 自动将Python添加到<code>环境变量</code></li>
<li>安装完毕后, 在命令行中键入 <code>python --version</code> 进行测试，显示出版本号即成功<br><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/python.png?raw=true" alt="预览"></li>
</ul>
<h3 id="Java环境"><a href="#Java环境" class="headerlink" title="Java环境"></a><strong>Java环境</strong></h3><ul>
<li>下载1.8版本JDK, <a href="http://www.oracle.com/technetwork/java/javase/overview/index.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/overview/index.html</a></li>
<li>安装完毕后, 需要手动配置环境变量<a href="http://jingyan.baidu.com/article/f96699bb8b38e0894e3c1bef.html" target="_blank" rel="noopener">http://jingyan.baidu.com/article/f96699bb8b38e0894e3c1bef.html</a><ol>
<li>系统环境变量中新增 <code>JAVA_HOME</code> 变量，值为 <code>C:\Program Files\Java\jdk1.8.0_112</code>, 即 jdk 的<code>安装</code>根路径</li>
<li>修改系统环境变量 <code>Path</code>, 在 Path 之后新增 <code>%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin</code></li>
<li>新增 <code>CLASSPATH</code> 变量, 值为 <code>.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar</code></li>
<li>配置完毕后保存并退出, 在命令行中分别键入<code>java</code> 与 <code>javac</code> 进行测试, 出现命令选项即配置成功</li>
</ol>
</li>
</ul>
<h3 id="Android环境"><a href="#Android环境" class="headerlink" title="Android环境"></a><strong>Android环境</strong></h3><ol>
<li><p>双击<code>installer_r24.3.4-windows.exe</code>安装androidSDK<br><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/android_sdk.png?raw=true" alt="每个用户"></p>
</li>
<li><p>进入安装目录，将<code>android-25</code>、<code>android-23</code>(react-native依赖)压缩包复制到<code>platforms</code>文件夹下，右键<code>解压</code>到当前文件夹</p>
</li>
<li><p>将<code>platform-tools_r23.1.0-windows</code>压缩包复制到<code>安装目录</code>，右键<code>解压</code>到当前文件夹</p>
</li>
<li><p><strong>tools文件夹不解压覆盖也行；</strong><del>解压<code>tools</code>，放到<code>tools</code>文件夹下</del></p>
</li>
<li><p>在安装目录新建一个<code>build-tools</code>文件夹，然后将<code>build-tools_r23.0.1-windows.zip(react-native依赖)</code>、<br><code>build-tools_r23.0.2-windows.zip(weex依赖)</code>和<code>build-tools_r23.0.3-windows.zip</code>压缩包复制到<code>build-tools</code>，<br>然后依次右键解压到当前文件夹，<code>解压后</code>的文件夹需要<code>修改名字</code>为对应的版本号<code>23.0.1</code>、<code>23.0.2</code>和<code>23.0.3</code></p>
</li>
<li><p>在安装目录中，新建<code>extras</code>文件夹，在<code>extras</code>文件夹下新建<code>android</code>文件夹<br>将<code>android_m2repository_r40.zip</code>与<code>support_r23.2.1.zip</code>压缩包复制到这个<code>android</code>文件夹，右键解压到当前文件夹</p>
</li>
<li><p>配置安装环境变量：在系统环境变量中新建<code>ANDROID_HOME</code>变量，值为SDK安装目录,<br>然后在Path中新增 <code>;%ANDROID_HOME%\tools;%ANDROID_HOME%\platform-tools;</code></p>
</li>
</ol>
<h2 id="环境测试与APP打包"><a href="#环境测试与APP打包" class="headerlink" title="环境测试与APP打包"></a>环境测试与APP打包</h2><h3 id="创建项目-1"><a href="#创建项目-1" class="headerlink" title="创建项目"></a>创建项目</h3><ul>
<li>使用<code>命令行</code>工具切入一个<code>目录</code>, 保证该目录及整个<code>路径</code>中没有任何<code>中文</code>字符串</li>
<li>然后运行 <code>react-native init project-name</code> 命令初始化一个 <code>React-Native</code> 项目</li>
<li>创建时过程中需要联网<code>下载</code>依赖包, 所以可能比较慢, 建议设置 <code>npm 或 yarn</code> 为国内镜像源</li>
</ul>
<h3 id="初始打包"><a href="#初始打包" class="headerlink" title="初始打包"></a>初始打包</h3><ul>
<li>运行 <code>cd project-name</code> 命令进入<code>项目</code>根目录</li>
<li>然后运行 <code>react-native run-android</code> 命令</li>
<li>该命令首先在本地启动一个端口<code>8081</code>的本地<code>服务器</code>, 用于向移动设备提供最新的项目打包生成的 <code>js</code> 文件</li>
<li>其次命令会打包 <code>android</code> 项目, 生成 <code>apk</code> 文件, 如果有移动设备连接了电脑, 还会自动帮你<code>安装</code></li>
</ul>
<h3 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h3><ul>
<li>打包好的 <code>apk</code> 安装包, 被放置到了 <code>/android/app/build/outputs/apk</code> 目录下</li>
<li>如果没有设备连接电脑, 或自动安装失败, 可自行把 <code>apk</code> 文件<code>拷贝</code>到手机存储器, 然后手动<code>安装</code></li>
</ul>
<h3 id="设置App权限"><a href="#设置App权限" class="headerlink" title="设置App权限"></a>设置App权限</h3><ul>
<li><code>App</code> 安装完毕要后<code>执行</code>, 需要确保其拥有<code>悬浮框</code>权限</li>
<li>可在<code>设置</code> =&gt; <code>授权管理</code> =&gt; <code>应用权限管理</code> 中找到对应的 APP , 然后<code>开启</code>悬浮框权限</li>
<li>有些手机需要关闭优化，比如MIUI系统手机需要进入开发者模式，关闭 “MIUI优化”</li>
</ul>
<h3 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h3><ul>
<li>App 权限设置完毕后, 关掉重新启动, 便会看到一个<code>欢迎</code>界面</li>
<li><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/react_welcome.png?raw=true" alt="欢迎页面"></li>
<li>也可以<code>摇一摇</code>手机, 唤起调试菜单, 点击第一个选项 <code>Reload</code>重新加载 <code>js</code> 执行</li>
<li><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/react_yaoyiyao.png?raw=true" alt="摇一摇弹出框"></li>
</ul>
<h2 id="常见打包失败问题"><a href="#常见打包失败问题" class="headerlink" title="常见打包失败问题"></a>常见打包失败问题</h2><ul>
<li>参考资料 <a href="http://www.open-open.com/lib/view/open1477469117948.html" target="_blank" rel="noopener">http://www.open-open.com/lib/view/open1477469117948.html</a></li>
<li>参考资料 <a href="http://reactnative.cn/docs/0.50/running-on-device-android.html#content" target="_blank" rel="noopener">http://reactnative.cn/docs/0.50/running-on-device-android.html#content</a></li>
</ul>
<h3 id="无法获取桥接"><a href="#无法获取桥接" class="headerlink" title="无法获取桥接"></a>无法获取桥接</h3><ul>
<li>提示: <code>Could not get BatchedBridge, make sure your bundle is packaged correctly</code></li>
<li>确保 <code>android/app/src/main/</code> 目录下有 <code>assets</code> 文件夹, 如果没有, 手动创建一个</li>
<li>然后在命令行工具中切入到项目根目录</li>
<li>执行命令: <code>react-native bundle --platform android --dev false --entry-file index.js --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res/</code></li>
</ul>
<h3 id="缺少许可"><a href="#缺少许可" class="headerlink" title="缺少许可"></a>缺少许可</h3><ul>
<li><strong>Windows脚本</strong><ul>
<li><code>mkdir &quot;%ANDROID_HOME%\licenses&quot;</code></li>
<li><code>echo |set /p=&quot;8933bad161af4178b1185d1a37fbf41ea5269c55&quot; &gt; &quot;%ANDROID_HOME%\licenses\android-sdk-license&quot;</code></li>
</ul>
</li>
<li><strong>Linux脚本</strong><ul>
<li><code>mkdir &quot;$ANDROID_HOME/licenses&quot;</code></li>
<li><code>echo -e &quot;\n8933bad161af4178b1185d1a37fbf41ea5269c55&quot; &gt; &quot;$ANDROID_HOME/licenses/android-sdk-license&quot;</code><br><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/bundle_error_license.png?raw=true" alt="缺少许可截图与解决方案"></li>
</ul>
</li>
</ul>
<h3 id="连接超时"><a href="#连接超时" class="headerlink" title="连接超时"></a>连接超时</h3><p><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/bundle_error_timeout.jpg?raw=true" alt="连接超时截图与解决方案"></p>
<hr>
<h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><h3 id="启动本地服务器"><a href="#启动本地服务器" class="headerlink" title="启动本地服务器"></a>启动本地服务器</h3><ul>
<li>之前运行 <code>react-native run-android</code> 打包命令的时候会自动启动一个本地<code>服务器</code>用于更新 js 代码</li>
<li>如果是项目的<code>后续</code>开发, 我们只需单独运行 <code>react-native start</code> 命令重新启动<code>服务器</code>即可</li>
<li>只要启动了, 我们就可以修改 <code>web</code> 代码, 将来移动设备 <code>Reload</code> 新代码即可预览最新效果</li>
</ul>
<h3 id="设备直连"><a href="#设备直连" class="headerlink" title="设备直连"></a>设备直连</h3><ol>
<li>准备一台 <code>Android</code> 手机, 通过数据线<code>连接</code>到电脑，设置启用<code>USB调试</code></li>
<li>一般的手机在<code>设置</code>中可以直接找到<code>开发者选项</code>进行开启, 如果<code>找不到</code>, 就自行百度查一下</li>
<li>手机连接成功后运行检测命令 <code>adb devices</code> , 如果有输出设备列表与 <code>ID</code> 相关的字符串就证明连接成功了<br><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/usb_debug.png?raw=true" alt="调试模式"><br><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/adb_devices.png?raw=true" alt="查看连接设备"></li>
<li>附录: 小米手机开启USB调试步骤<ul>
<li>首先进入<code>设置</code> =&gt; <code>我的设备</code> =&gt; <code>全部参数</code> =&gt; 连续<code>点击</code>MUI版本3次以上</li>
<li>然后重新进入<code>设置</code> =&gt; <code>更多设置</code> =&gt; <code>开发者选项</code>(在无障碍下面) =&gt; 找到<code>USB调试</code>点击开启</li>
<li>最后需要拉到底部找到<code>启用 MUI 优化</code>, 关掉重启</li>
</ul>
</li>
</ol>
<h3 id="局域网连接"><a href="#局域网连接" class="headerlink" title="局域网连接"></a>局域网连接</h3><ul>
<li>移动设备除了通过 <code>USB</code> 直连电脑调试开发, 还可以采用<code>无线</code>的方式进行调试</li>
<li>只要保证手机和电脑在同一个<code>局域网</code>, 然后摇一摇唤出调试菜单</li>
<li>点击 <code>Dev settings</code> =&gt; <code>Debuug server host</code> , 配置本地 <code>IP</code> 地址和端口号 <code>8081</code> 即可</li>
<li>如果出现这个<code>错误</code>提示, 说明配置错了: <code>could not connect to development server</code></li>
<li><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/react_debug_server.png?raw=true" alt="摇一摇弹出框"></li>
</ul>
<h3 id="调试菜单说明"><a href="#调试菜单说明" class="headerlink" title="调试菜单说明"></a>调试菜单说明</h3><ul>
<li>Reload: 重新加载整个页面</li>
<li>Debug JS Remotely: 启动远程调试, 会自动打开chrome浏览器, 然后可在开发者工具中调试js</li>
<li>Enable Live Reload: 开启自动加载, 代码变动会自动更新整个页面</li>
<li>Enable Hot Reloading: 热更新, 代码变动自动的进行局部更新</li>
<li>Show Perf Monitor: 打开性能监控，可查看UI与JS运行性能</li>
<li>Dev Sttings: 开发调试配置</li>
</ul>
<hr>
<h2 id="打包正式版"><a href="#打包正式版" class="headerlink" title="打包正式版"></a>打包正式版</h2><p>1、产生签名的key</p>
<p>该过程会用到keytool密钥和证书管理工具，在项目的主目录（不是android文件夹）中执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 生成签名key，注意记下你的密钥和存储密码，后面配置文件需要使用</span><br><span class="line">keytool -genkey -v -keystore my-release-key.keystore -alias 自己起的别名 -keyalg RSA -keysize 2048 -validity 10000</span><br><span class="line"></span><br><span class="line">// 将keystore文件移动至android/app/文件夹</span><br><span class="line">move my-release-key.keystore android/app/</span><br></pre></td></tr></table></figure>
<p>2、修改android/gradle.properties文件，增加如下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MYAPP_RELEASE_STORE_FILE=my-release-key.keystore</span><br><span class="line">MYAPP_RELEASE_KEY_ALIAS=自己起的别名</span><br><span class="line">MYAPP_RELEASE_STORE_PASSWORD=存储密码</span><br><span class="line">MYAPP_RELEASE_KEY_PASSWORD=密钥</span><br></pre></td></tr></table></figure>
<p>3、修改android/app/build.gradle文件，增加如下签名配置</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">android &#123; </span><br><span class="line">  signingConfigs &#123; </span><br><span class="line">    release &#123; </span><br><span class="line">        storeFile <span class="keyword">file</span>(MYAPP_RELEASE_STORE_FILE) </span><br><span class="line">        storePassword MYAPP_RELEASE_STORE_PASSWORD </span><br><span class="line">        keyAlias MYAPP_RELEASE_KEY_ALIAS </span><br><span class="line">        keyPassword MYAPP_RELEASE_KEY_PASSWORD </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  buildTypes &#123; </span><br><span class="line">    release &#123; </span><br><span class="line">      signingConfig signingConfigs.release </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、打包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 在android/app/build/outputs/apk/文件夹中生产可以发布的app-release.apk文件</span><br><span class="line">cd android</span><br><span class="line">gradlew assembleRelease</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/14/react-native基础组件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/14/react-native基础组件/" itemprop="url">react-native基础组件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-14T23:42:30+08:00">
                2019-07-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/14/react-native基础组件/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/07/14/react-native基础组件/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ReactNative-快速开始"><a href="#ReactNative-快速开始" class="headerlink" title="ReactNative 快速开始"></a>ReactNative 快速开始</h1><p>学习使用 ReactNative 最令人头疼的就是环境问题，因为大多数 Web 开发者，并不熟悉 Android 与 IOS 的开发环境，配置起来比较繁琐。当然 Android 程序员也不熟悉 IOS 环境，反之亦然，这导致很多人因为繁杂的开发环境而放弃学习或者暂时搁浅。</p>
<p>为了改善这个问题，一个快速的开发环境解决方案应运而生。这个方案需要两个工具：1. create-react-native-app 2. Expo。</p>
<h2 id="create-react-native-app"><a href="#create-react-native-app" class="headerlink" title="create-react-native-app"></a>create-react-native-app</h2><p>这是一款用来创建 ReactNative 项目的脚手架工具。特点是无需配置繁杂的 Android 或 IOS 开发环境，便可进行原生应用的开发，极大简化了环境搭建与配置的过程，很适合学习使用。</p>
<ul>
<li>[参考文档] <a href="https://reactnative.cn/docs/getting-started.html" target="_blank" rel="noopener">https://reactnative.cn/docs/getting-started.html</a></li>
<li>[替代方案] <a href="https://facebook.github.io/react-native/docs/getting-started.html" target="_blank" rel="noopener">https://facebook.github.io/react-native/docs/getting-started.html</a></li>
</ul>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">npm install -g create-react-native-app</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检测，文档更新时最新版本2.0.2</span></span><br><span class="line">create-react-native-app --version</span><br></pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建项目</span></span><br><span class="line">create-react-native-app projectName</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动项目</span></span><br><span class="line">cd projectName</span><br><span class="line">expo start</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Expo"><a href="#Expo" class="headerlink" title="Expo"></a>Expo</h2><p>这是一款安装在手机上的应用，专门负责运行上述方式构建的 App，这有点像是微信里面运行的小程序。IOS 可以到 AppStore 里面搜索下载，Android 可以到 GooglePlay 里面搜索下载，也可以到 Github 里下载。</p>
<ul>
<li>[Github] <a href="https://github.com/expo/expo" target="_blank" rel="noopener">https://github.com/expo/expo</a></li>
</ul>
<hr>
<h2 id="真机运行"><a href="#真机运行" class="headerlink" title="真机运行"></a>真机运行</h2><p>准备工作：使用<code>create-react-native-app</code>创建一个项目，然后手机安装<code>Expo</code>应用，并确保手机与开发机处于同一局域网下。</p>
<p>项目运行：<code>npm start</code>启动项目，打开<code>Expo</code>应用，使用里面的扫一扫功能，扫描项目启动后生成的巨大二维码，等待JS打包传输完毕，就会在手机上运行。</p>
<h3 id="IP错误问题"><a href="#IP错误问题" class="headerlink" title="IP错误问题"></a>IP错误问题</h3><p>因为开发机可能会有多个ip地址，比如以太网IP、虚拟IP、无线局域网IP等等。当项目启动时通常会无脑的选择IP列表中的第一个，假如是以太网IP，那么就与手机所处的无线局域网不同，造成网络连接失败。</p>
<p>下面是这种情况的图例，项目启动时使用的是IP列表中的第一个94 IP，并没有使用无线局域网IP。<br></p>
<p><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/ipconfig.png?raw=true" alt="ipconfig"></p>
<p><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/expo_service.png?raw=true" alt="expo-service"></p>
<p>如果发生这种情况，先<code>Ctrl+C</code>停掉项目，设置一个环境变量，然后再重启项目即可。</p>
<ul>
<li>[参考解决方案] <a href="https://github.com/react-community/create-react-native-app/blob/d01ddabb634532200629c6d17f920eb856fa6416/react-native-scripts/template/README.md#environment-variables" target="_blank" rel="noopener">https://github.com/react-community/create-react-native-app/blob/d01ddabb634532200629c6d17f920eb856fa6416/react-native-scripts/template/README.md#environment-variables</a></li>
<li>[参考解决方案] <a href="https://github.com/react-community/create-react-native-app/issues/270" target="_blank" rel="noopener">https://github.com/react-community/create-react-native-app/issues/270</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置环境变量</span></span><br><span class="line">set REACT_NATIVE_PACKAGER_HOSTNAME=my-custom-ip-address-or-hostname</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启项目</span></span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="开发初体验"><a href="#开发初体验" class="headerlink" title="开发初体验"></a>开发初体验</h2><ul>
<li>在项目根目录下有个 <code>App.js</code> , 是应用的<code>根组件</code>, 我们手机上看到的<code>内容</code>就是这个组件实现的</li>
<li>尝试修改 <code>App.js</code> 中的文本内容, 然后手机摇一摇, 点击 <code>Reload</code> 选项即可更新修改内容</li>
<li>也可尝试给文本添加新的样式</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, Text, View &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出根组件, 组件的定于语法与之前学习的一样</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="comment">// 返回的视图需要使用View组件包裹, 作用相当于Div标签</span></span><br><span class="line">        &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">            &#123;<span class="comment">/* 文本内容使用Text组件包裹, 作用相当于P标签 */</span>&#125;</span><br><span class="line">            &lt;Text&gt;Open up App.js to start working on your app!&lt;/Text&gt;</span><br><span class="line">        &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 定义样式, 这里的尺寸大小无需加单位, 元素可以通过数组引用多个样式, 后面的样式优先级比前面的高</span></span><br><span class="line"><span class="regexp">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">  container: &#123;</span></span><br><span class="line"><span class="regexp">    flex: 1,</span></span><br><span class="line"><span class="regexp">    backgroundColor: '#fff',</span></span><br><span class="line"><span class="regexp">    alignItems: 'center',</span></span><br><span class="line"><span class="regexp">    justifyContent: 'center',</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="错误提示-红屏和黄屏"><a href="#错误提示-红屏和黄屏" class="headerlink" title="错误提示 - 红屏和黄屏"></a>错误提示 - 红屏和黄屏</h2><p>RN代码运行时会把错误分为红屏和黄屏两种，红屏会以全屏红色显示在应用中，导致程序无法正常运行，红屏通常是编码错误导致的，必须修复。<br></p>
<p>黄屏代表警告，会显示在应用下方，不影响程序运行，不修复也可以，警告可以通过代码禁止。<br></p>
<p>红屏和黄屏只在debug版本中才会显示，在rellease版本中不会。一般情况下，通过RN红屏中的错误提示信息，就可以定位问题，如果是语法等常见运行错误，RN也会给出错误代码所在位置与行数，所以出现红屏一定要阅读描述信息。<br></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 频闭黄色警告，参数为一个数组：数组中的字符串就是要屏蔽的警告的开头的内容。</span></span><br><span class="line">YellowBox.ignoreWarnings([<span class="string">'Warning: '</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动触发红屏和警告</span></span><br><span class="line"><span class="built_in">console</span>.error(<span class="string">"严重错误"</span>);</span><br><span class="line"><span class="built_in">console</span>.warn(<span class="string">"警告"</span>);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="调试菜单"><a href="#调试菜单" class="headerlink" title="调试菜单"></a>调试菜单</h2><p>React-Native开发调试没有本地代码方便，但也是可以调的，在调试菜单中可以进行开发调试相关的配置。调试菜单只在debug版本中可以被调出，如果是模拟器环境，Windows平台按window+m可调出，也可能是F1或F2，Mac平台按commond+m可调出，或者发送<code>adb shell input keyevent 82</code>指令。如果是真机，摇一摇就可以调出调试菜单。<br></p>
<p><img src="https://note.youdao.com/yws/public/resource/6a301213468716d4d839ca93f6b26025/xmlnote/5F7D6A3BB20945BE8C521606F0DD0C76/6915" alt="调试菜单预览"></p>
<p>调试菜单说明</p>
<ul>
<li>Reload: 重新加载整个页面</li>
<li>Debug JS Remotely: 启动远程调试, 会自动打开chrome浏览器, 然后可在开发者工具中调试js</li>
<li>Enable Live Reload: 开启自动加载, 代码变动会自动更新整个页面</li>
<li>Enable Hot Reloading: 热更新, 代码变动自动的进行局部更新</li>
<li>Dev Sttings: 开发调试配置</li>
</ul>
<hr>
<h2 id="内置组件"><a href="#内置组件" class="headerlink" title="内置组件"></a>内置组件</h2><ul>
<li>在 <code>React Native</code> 中你需要使用官方提供的<code>组件</code>进行应用构建</li>
<li>因为是开发<code>原生</code>应用, 我们的代码最终会<code>转为</code>原生组件的方式渲染, 所以你不会看到任何以 <code>html</code> 标签命名的组件</li>
<li>[官方文档] <a href="https://facebook.github.io/react-native/docs/getting-started" target="_blank" rel="noopener">https://facebook.github.io/react-native/docs/getting-started</a></li>
</ul>
<h3 id="View"><a href="#View" class="headerlink" title="View"></a>View</h3><ul>
<li>视图容器，作用相当于 <code>html</code> 的 <code>div</code> 标签，它是创建UI所需的最基础组件，支持Flexbox布局、样式、触摸事件，它可以放到其它视图中，也可以包含任意多个任意子视图。</li>
<li><a href="https://reactnative.cn/docs/view/" target="_blank" rel="noopener">https://reactnative.cn/docs/view/</a></li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, View, Text, Button &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &#123;<span class="comment">/* View标签相当于div，可以嵌套 */</span>&#125;</span><br><span class="line">            &lt;View style=&#123;style.container&#125;&gt;</span><br><span class="line">                &lt;View&gt;</span><br><span class="line">                    &lt;Text&gt;React Native&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>View&gt;</span><br><span class="line">                &lt;View&gt;</span><br><span class="line">                    &lt;Text&gt;使用React编写&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                    &lt;Text&gt;使用JSX编写&lt;/</span>Text&gt;</span><br><span class="line">                &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>View&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意border、background等样式不能简写，必须一个一个的设置属性</span></span><br><span class="line"><span class="keyword">let</span> style = StyleSheet.create(&#123;</span><br><span class="line">    container: &#123;</span><br><span class="line">        width: <span class="number">300</span>,</span><br><span class="line">        padding: <span class="number">10</span>,</span><br><span class="line">        borderStyle: <span class="string">"dashed"</span>,</span><br><span class="line">        borderWidth: <span class="number">2</span>,</span><br><span class="line">        borderColor: <span class="string">"red"</span>,</span><br><span class="line">        borderRadius: <span class="number">2</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    text: &#123;</span><br><span class="line">        fontSize: <span class="number">20</span>,</span><br><span class="line">        color: <span class="string">"yellow"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Text"><a href="#Text" class="headerlink" title="Text"></a>Text</h3><ul>
<li>文本容器，作用相当于 <code>html</code> 的 <code>span</code> 标签，为什么不是 <code>p</code> 标签呢，一会演示。Text标签支持嵌套、触摸事件。在RN中，文本必须放置到Text中才可以被渲染，否则报错。</li>
<li>注意: 除了Text外, 别的组件内都不能包含文本</li>
<li><a href="https://reactnative.cn/docs/text/" target="_blank" rel="noopener">https://reactnative.cn/docs/text/</a></li>
</ul>
<p>文本布局</p>
<p>Text采用的是文本布局，多个子文本在渲染时会折叠合并在一起，如果把View理解成块级元素，那么Text就可以理解为行内元素。<br></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, View, Text &#125; <span class="keyword">from</span> <span class="string">"react-native"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">TextTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="comment">// 可以嵌套</span></span><br><span class="line">            &lt;Text&gt;</span><br><span class="line">                &#123;<span class="comment">/* 文本节点是span版本的p标签，行内元素，下面文字会合并在一行 */</span>&#125;</span><br><span class="line">                &lt;Text&gt;饿了吗&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                &lt;Text&gt;美图&lt;/</span>Text&gt;</span><br><span class="line">            &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>文本样式</strong></p>
<p>在RN中，父文本的样式可以传递给后代文本，也就是样式继承。但是除了文本之外其它组件都无法继承样式。<br></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;Text style=&#123;style.rootText&#125;&gt;</span><br><span class="line">            &lt;Text&gt;饿了吗&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Text&gt;美图&lt;/</span>Text&gt;</span><br><span class="line">            &#123;<span class="comment">/* 文本样式继承 */</span>&#125;</span><br><span class="line">            &lt;Text&gt;</span><br><span class="line">                &lt;Text&gt;滴滴外卖&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>Text&gt;</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">let style = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">    rootText: &#123;</span></span><br><span class="line"><span class="regexp">        fontSize: 20,</span></span><br><span class="line"><span class="regexp">        color: "blue",</span></span><br><span class="line"><span class="regexp">        lineHeight: 24</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>
<h3 id="Image"><a href="#Image" class="headerlink" title="Image"></a>Image</h3><ul>
<li>作用相当于 <code>html</code> 的 <code>img</code> 标签用于承载图片</li>
<li>组件通过 <code>source</code> 属性设置图片地址</li>
<li><a href="https://reactnative.cn/docs/image.html" target="_blank" rel="noopener">https://reactnative.cn/docs/image.html</a></li>
<li><a href="http://reactnative.cn/docs/0.50/images.html#content" target="_blank" rel="noopener">http://reactnative.cn/docs/0.50/images.html#content</a></li>
</ul>
<h4 id="载入本地图片"><a href="#载入本地图片" class="headerlink" title="载入本地图片"></a>载入本地图片</h4><ul>
<li>本地图片通过<code>require</code>方法导入</li>
<li>之前的版本中require方法必须传入<code>静态字符串</code>，不能使用表达式和字符串拼接, 也就是写死，同时图片名称也不允许以<code>数字</code>开头，现在的新版本已经修复了这两个bug</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, View, Image &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">let</span> pic = &#123;</span><br><span class="line">            uri: <span class="string">'https://ss1.baidu.com/6ONXsjip0QIZ8tyhnq/it/u=645293140,2005760885&amp;fm=173'</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> imgBasePath = <span class="string">"../public/img/"</span>;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View &gt;</span><br><span class="line">                &#123;<span class="comment">/* 通过source属性设置图片地址，通过require方法载入本地图片 */</span>&#125;</span><br><span class="line">                &lt;Image style=&#123;styles.img&#125; source=&#123;<span class="built_in">require</span>(<span class="string">'../public/img/12.jpg'</span>)&#125;/&gt;</span><br><span class="line">                </span><br><span class="line">                &#123;<span class="comment">/* 在之前的版本中，图片路径必须是静态的，不能写表达式，现在可以了 */</span>&#125;</span><br><span class="line">                &lt;Image style=&#123;styles.img&#125; source=&#123;<span class="built_in">require</span>(imgBasePath + <span class="string">'12.jpg'</span>)&#125; /&gt;</span><br><span class="line">                </span><br><span class="line">                &#123;<span class="comment">/* 在之前的版本中，图片名称也不能以数字开头，现在也可以了 */</span>&#125;</span><br><span class="line">                &lt;Image style=&#123;styles.img&#125; source=&#123;<span class="built_in">require</span>(<span class="string">'./56.jpg'</span>)&#125; /&gt;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">let styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">    img: &#123;</span></span><br><span class="line"><span class="regexp">        width: 55,</span></span><br><span class="line"><span class="regexp">        height: 55</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>
<h4 id="载入网络图片"><a href="#载入网络图片" class="headerlink" title="载入网络图片"></a>载入网络图片</h4><ul>
<li>如果是通过uri载入的网络图片，必须要设置宽高，否则无法显示</li>
<li>如果某些网站的图片载入失败尝试换一个域名图片试试</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">let</span> pic = &#123;</span><br><span class="line">            uri: <span class="string">'https://ss1.baidu.com/6ONXsjip0QIZ8tyhnq/it/u=645293140,2005760885&amp;fm=173'</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> imgBasePath = <span class="string">"../public/img/"</span>;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View &gt;</span><br><span class="line">                &#123;<span class="comment">/* 没有宽高，图片不会显示 */</span>&#125;</span><br><span class="line">                &lt;Image source=&#123;pic&#125; /&gt;</span><br><span class="line"></span><br><span class="line">                &#123;<span class="comment">/* 设置宽高，图片正常显示 */</span>&#125;</span><br><span class="line">                &lt;Image source=&#123;pic&#125; style=&#123;&#123;<span class="attr">width</span>:<span class="number">200</span>, <span class="attr">height</span>: <span class="number">100</span>&#125;&#125; /&gt;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="批量载入网络图片"><a href="#批量载入网络图片" class="headerlink" title="批量载入网络图片"></a>批量载入网络图片</h4><ul>
<li>之前如果想<code>写活</code>地址, 必须定义一个<code>对象</code>赋值</li>
<li><code>&lt;Image source={对象} /&gt;</code></li>
<li>现在更加灵活，只需要把uri写活就可以</li>
<li><code>&lt;Image source={uri: 变量} /&gt;</code></li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, View, Image &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">        <span class="keyword">super</span>(props);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>.props.imgs &amp;&amp; <span class="keyword">this</span>.props.imgs.map(<span class="function">(<span class="params">uri, i</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> &lt;Image key=&#123;`key$&#123;i&#125;`&#125; source=&#123;&#123;uri: uri&#125;&#125; style=&#123;&#123;width:200, height: 100&#125;&#125; /&gt;;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &lt;/View&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Button"><a href="#Button" class="headerlink" title="Button"></a>Button</h3><ul>
<li>作用相当于 <code>html</code> 的 <code>button</code> 标签用于触发点击</li>
<li>按钮需要通过 <code>title</code> 属性设置文本内容, 值必须为字符串，其他数值或者不设都会报错</li>
<li>按钮通过 <code>onPress</code> 属性监听点击事件</li>
<li><a href="http://reactnative.cn/docs/0.50/button.html" target="_blank" rel="noopener">http://reactnative.cn/docs/0.50/button.html</a></li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, View, Text, Button, Alert &#125; <span class="keyword">from</span> <span class="string">"react-native"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ButtonTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">        <span class="keyword">super</span>(props);</span><br><span class="line">        <span class="keyword">this</span>.state = &#123;</span><br><span class="line">            num: <span class="number">1</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onPressHandler() &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">num</span>: ++<span class="keyword">this</span>.state.num&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View&gt;</span><br><span class="line">                &lt;Text&gt;&#123;<span class="keyword">this</span>.state.num&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                &lt;Button onPress=&#123;() =&gt; &#123;this.onPressHandler()&#125;&#125; title="点我+1"&gt;&lt;/</span>Button&gt;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="TextInput"><a href="#TextInput" class="headerlink" title="TextInput"></a>TextInput</h3><ul>
<li>作用相当于 <code>html</code> 的 <code>input</code> 标签用于输入文本</li>
<li>需要通过 <code>value</code> 属性指定文本内容, 通过 <code>onChangeText</code> 属性监听文本的变化事件</li>
<li><a href="http://reactnative.cn/docs/0.50/textinput.html#content" target="_blank" rel="noopener">http://reactnative.cn/docs/0.50/textinput.html#content</a></li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, View, Text, TextInput &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">TextInputTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">        <span class="keyword">super</span>(props);</span><br><span class="line">        <span class="keyword">this</span>.state = &#123;</span><br><span class="line">            text: <span class="string">'默认值'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View&gt;</span><br><span class="line">                &#123;<span class="comment">/* 模拟双向数据绑定 */</span>&#125;</span><br><span class="line">      			&lt;Text&gt;&#123; <span class="keyword">this</span>.state.text &#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                &lt;TextInput value=&#123; this.state.text &#125; onChangeText=&#123;(text) =&gt; this.setState(&#123;text&#125;)&#125; /</span>&gt;</span><br><span class="line">                &lt;Text&gt;&#123; <span class="keyword">this</span>.state.text &#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">    			&lt;TextInput placeholder="请输入密码" onChangeText=&#123;(text) =&gt; this.setState(&#123;text&#125;)&#125; /</span>&gt;</span><br><span class="line">	    	&lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Alert"><a href="#Alert" class="headerlink" title="Alert"></a>Alert</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, View, Text, Button, Alert &#125; <span class="keyword">from</span> <span class="string">"react-native"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">AlertTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    onPressHanlder() &#123;</span><br><span class="line">        Alert.alert(</span><br><span class="line">            <span class="comment">// 标题</span></span><br><span class="line">            <span class="string">'温馨提示'</span>,</span><br><span class="line">            <span class="comment">// 内容</span></span><br><span class="line">            <span class="string">'您的餐凉了，要不要热一下'</span>,</span><br><span class="line">            <span class="comment">// 配置一个按钮是确定，两个按钮是取消与确定，三个按钮是稍后再试、取消与确定</span></span><br><span class="line">            [</span><br><span class="line">              &#123;<span class="attr">text</span>: <span class="string">'再等一会'</span>, <span class="attr">onPress</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'先聊会天'</span>)&#125;,</span><br><span class="line">              &#123;<span class="attr">text</span>: <span class="string">'算了'</span>, <span class="attr">onPress</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'凉着吃吧'</span>)&#125;,</span><br><span class="line">              &#123;<span class="attr">text</span>: <span class="string">'好的'</span>, <span class="attr">onPress</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'热的好吃'</span>)&#125;,</span><br><span class="line">            ],</span><br><span class="line">            <span class="comment">// 点击屏幕关闭</span></span><br><span class="line">            &#123; <span class="attr">cancelable</span>: <span class="literal">false</span> &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;Button onPress=&#123;()=&gt;&#123;<span class="keyword">this</span>.onPressHanlder()&#125;&#125; title=<span class="string">"点我弹框"</span>&gt;&lt;/Button&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Dimensions"><a href="#Dimensions" class="headerlink" title="Dimensions"></a>Dimensions</h3><p>有时候我们需要设置元素大小为屏幕的大小，在Web开发中可以使用%百分比单位，但是RN并不支持这种单位，这时候我们可以使用RN内置的<code>Dimensions</code>对象API方法动态获取屏幕宽高然后进行设置。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Dimensions = <span class="built_in">require</span>(<span class="string">'Dimensions'</span>);</span><br><span class="line"><span class="keyword">const</span> screenSize = Dimensions.get(<span class="string">"window"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = StyleSheet.create(&#123;</span><br><span class="line">    container: &#123;</span><br><span class="line">        width: screenSize.width,</span><br><span class="line">        height: screenSize.height</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="ScrollView"><a href="#ScrollView" class="headerlink" title="ScrollView"></a>ScrollView</h3><ul>
<li>默认情况下, <code>超出</code>屏幕的内容是看不到的, 不像浏览器环境下会自动添加<code>滚动条</code></li>
<li>如果需要滚动, 可以使用这个<code>组件</code>把要相应的内容<code>包裹</code>起来, 被包裹的内容就会处于<code>滚动条</code>中</li>
<li>滚动的过程中，可以通过onScroll绑定回调，每帧最多调用一次回调</li>
<li><a href="http://reactnative.cn/docs/0.50/scrollview.html#content" target="_blank" rel="noopener">http://reactnative.cn/docs/0.50/scrollview.html#content</a></li>
</ul>
<p><strong>基本使用</strong></p>
<p>ScrollView使用非常简单，只需要把标签内容通过ScrollView组件包裹起来即可。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (</span><br><span class="line">    &lt;ScrollView&gt;</span><br><span class="line">        &lt;View style=&#123;styles.container&#125; onScroll=&#123;() =&gt; &#123;<span class="keyword">this</span>.onScrollHandler()&#125;&#125;&gt;</span><br><span class="line">            &lt;Text&gt;Open up App.js to start working on your app!&lt;/Text&gt;</span><br><span class="line">            &lt;Text&gt;Changes you make will automatically reload.&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Text&gt;Shake your phone to open the developer menu1.&lt;/</span>Text&gt;</span><br><span class="line">            &lt;ViewTest&gt;&lt;/ViewTest&gt;</span><br><span class="line">            &lt;ViewTest&gt;&lt;/ViewTest&gt;</span><br><span class="line">            &lt;ViewTest&gt;&lt;/ViewTest&gt;</span><br><span class="line">            &lt;ViewTest&gt;&lt;/ViewTest&gt;</span><br><span class="line">            &lt;ViewTest&gt;&lt;/ViewTest&gt;</span><br><span class="line">            &lt;ViewTest&gt;&lt;/ViewTest&gt;</span><br><span class="line">            &lt;ViewTest&gt;&lt;/ViewTest&gt;</span><br><span class="line">            &lt;TextTest&gt;&lt;/TextTest&gt;</span><br><span class="line">            &lt;ImageTest imgs=&#123;imgs&#125;&gt;&lt;/ImageTest&gt;</span><br><span class="line">            &lt;ButtonTest&gt;&lt;/ButtonTest&gt;</span><br><span class="line">            &lt;TextInputTest&gt;&lt;/TextInputTest&gt;</span><br><span class="line">            &lt;AlertTest&gt;&lt;/AlertTest&gt;</span><br><span class="line">        &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>ScrollView&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><strong>简易Swiper</strong></p>
<p>我们可以利用ScrollView的几个特殊属性来实现一个简易的Swiper。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    StyleSheet,</span><br><span class="line">    View,</span><br><span class="line">    Text,</span><br><span class="line">    ScrollView</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Dimensions = <span class="built_in">require</span>(<span class="string">'Dimensions'</span>);</span><br><span class="line"><span class="keyword">const</span> screenSize = Dimensions.get(<span class="string">"window"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ScrollViewSwiper</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取渲染列表</span></span><br><span class="line">    getList() &#123;</span><br><span class="line">        <span class="keyword">const</span> backgroundList = [<span class="string">"orange"</span>, <span class="string">"purple"</span>, <span class="string">"pink"</span>, <span class="string">"aqua"</span>];</span><br><span class="line">        <span class="keyword">return</span> backgroundList.map(<span class="function">(<span class="params">color, i</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                &lt;View</span><br><span class="line">                    key=&#123; <span class="string">`key<span class="subst">$&#123;i&#125;</span>`</span> &#125; </span><br><span class="line">                    style=&#123; [styles.swipeItem, &#123;<span class="attr">backgroundColor</span>: color&#125;] &#125;&gt;</span><br><span class="line">                    &lt;Text&gt;&#123; color &#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>View&gt;</span><br><span class="line">            )</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="comment">// horizontal属性可设置列表水平排列，</span></span><br><span class="line">            <span class="comment">// pagingEnabled属性能够让列表一页一页切换，</span></span><br><span class="line">            <span class="comment">// showsHorizontalScrollIndicator属性控制滚动条显示隐藏</span></span><br><span class="line">            &lt;ScrollView</span><br><span class="line">                style=&#123;styles.swipe&#125;</span><br><span class="line">                horizontal=&#123; <span class="literal">true</span> &#125;</span><br><span class="line">                pagingEnabled=&#123; <span class="literal">true</span> &#125;</span><br><span class="line">                showsHorizontalScrollIndicator=&#123; <span class="literal">false</span> &#125;&gt;</span><br><span class="line">                &#123; <span class="keyword">this</span>.getList() &#125;</span><br><span class="line">            &lt;<span class="regexp">/ScrollView&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">    swipe: &#123;</span></span><br><span class="line"><span class="regexp">        marginTop: 24,</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">    swipeItem: &#123;</span></span><br><span class="line"><span class="regexp">        width: screenSize.width,</span></span><br><span class="line"><span class="regexp">        height: 200</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>
<h3 id="FlatList"><a href="#FlatList" class="headerlink" title="FlatList"></a>FlatList</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, View, Text, FlatList &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">FlatListTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View&gt;</span><br><span class="line">                &lt;FlatList</span><br><span class="line">                    data=&#123;[</span><br><span class="line">                        &#123;<span class="attr">key</span>: <span class="string">'Devin'</span>&#125;,</span><br><span class="line">                        &#123;<span class="attr">key</span>: <span class="string">'Jackson'</span>&#125;,</span><br><span class="line">                        &#123;<span class="attr">key</span>: <span class="string">'James'</span>&#125;,</span><br><span class="line">                        &#123;<span class="attr">key</span>: <span class="string">'Joel'</span>&#125;,</span><br><span class="line">                        &#123;<span class="attr">key</span>: <span class="string">'John'</span>&#125;,</span><br><span class="line">                        &#123;<span class="attr">key</span>: <span class="string">'Jillian'</span>&#125;,</span><br><span class="line">                        &#123;<span class="attr">key</span>: <span class="string">'Jimmy'</span>&#125;,</span><br><span class="line">                        &#123;<span class="attr">key</span>: <span class="string">'Julie'</span>&#125;,</span><br><span class="line">                    ]&#125;</span><br><span class="line">                    renderItem=&#123;(e) =&gt; &lt;Text style=&#123;styles.item&#125;&gt;&#123;e.index + ":" + e.item.key&#125;&lt;/Text&gt;&#125;</span><br><span class="line">                /&gt;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">        </span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">    item: &#123;</span></span><br><span class="line"><span class="regexp">        padding: 10,</span></span><br><span class="line"><span class="regexp">        fontSize: 18,</span></span><br><span class="line"><span class="regexp">        height: 44,</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>
<h3 id="ActivityIndicator"><a href="#ActivityIndicator" class="headerlink" title="ActivityIndicator"></a>ActivityIndicator</h3><ul>
<li>展示一个小圆形的<code>loading</code></li>
<li>通过属性 <code>animating</code> 控制显示隐藏, <code>color</code> 设置颜色</li>
<li><a href="http://reactnative.cn/docs/0.50/activityindicator.html#content" target="_blank" rel="noopener">http://reactnative.cn/docs/0.50/activityindicator.html#content</a></li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StyleSheet, ActivityIndicator &#125; <span class="keyword">from</span> <span class="string">"react-native"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityIndicatorTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">        <span class="keyword">super</span>(props);</span><br><span class="line">        <span class="keyword">this</span>.state = &#123;</span><br><span class="line">            isShow: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;ActivityIndicator animating=&#123;<span class="keyword">this</span>.state.isShow&#125; color=<span class="string">"green"</span> size=<span class="string">"large"</span>&gt;&lt;/ActivityIndicator&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="触控系列组件"><a href="#触控系列组件" class="headerlink" title="触控系列组件"></a>触控系列组件</h3><p>在需要捕捉用户点击操作时，可以使用<code>Touchable</code>开头的一系列组件。这些组件通过onPress属性设置点击事件的处理函数。当在本组件上按下手指并且抬起手指时也没有移开到组件外时，此函数会被调用。Touchable组件最大的特点是附带反馈效果。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; </span><br><span class="line">    StyleSheet, </span><br><span class="line">    View, </span><br><span class="line">    Image,</span><br><span class="line">    Text, </span><br><span class="line">    TouchableHighlight, </span><br><span class="line">    TouchableOpacity, </span><br><span class="line">    TouchableNativeFeedback </span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"><span class="keyword">import</span> StyleBoxTest <span class="keyword">from</span> <span class="string">'./StyleBoxTest'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">TouchableGroupTest</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    opacityHandler() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"透明按钮"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HighlighrHandler() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"高亮按钮"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FeedbackHandler() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"原生反馈按钮"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View&gt;</span><br><span class="line">                &#123;<span class="comment">/* 透明效果，支持多个子节点 */</span>&#125;</span><br><span class="line">                &lt;TouchableOpacity </span><br><span class="line">                    activeOpacity=&#123;<span class="number">0.5</span>&#125; </span><br><span class="line">                    onPress=&#123;<span class="keyword">this</span>.opacityHandler.bind(<span class="keyword">this</span>)&#125;&gt;</span><br><span class="line">                    &lt;View style=&#123;styles.base&#125;&gt;</span><br><span class="line">                        &lt;Text style=&#123;styles.baseFont&#125;&gt;透明按钮&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                    &lt;/</span>View&gt;</span><br><span class="line">                &lt;<span class="regexp">/TouchableOpacity&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                &#123;/</span>* 透明与底色两种效果，只支持一个子节点，可以用一个View再包装多个子节点 *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">                &#123;/</span>* 可以包裹图片，点击时加深背景 *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">                &lt;TouchableHighlight</span></span><br><span class="line"><span class="regexp">                    activeOpacity=&#123;0.5&#125; </span></span><br><span class="line"><span class="regexp">                    underlayColor="#c1c1c1"</span></span><br><span class="line"><span class="regexp">                    onPress=&#123;this.HighlighrHandler.bind(this)&#125;&gt;</span></span><br><span class="line"><span class="regexp">                    &lt;View style=&#123;styles.base&#125;&gt;</span></span><br><span class="line"><span class="regexp">                        &lt;Image source=&#123;require("./</span><span class="number">56.</span>jpg<span class="string">")&#125; style=&#123;&#123;width:300,height:100&#125;&#125; resizeMode="</span>stretch<span class="string">"&gt;&lt;/Image&gt;</span></span><br><span class="line"><span class="string">                    &lt;/View&gt;</span></span><br><span class="line"><span class="string">                &lt;/TouchableHighlight&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                &#123;/* 使用原生状态渲染反馈效果，比如涟漪，只能放置一个view子组件 */&#125;</span></span><br><span class="line"><span class="string">                &#123;/* 效果有三个可选方法：SelectableBackground、SelectableBackgroundBorderless、Ripple(color)*/&#125;</span></span><br><span class="line"><span class="string">                &lt;TouchableNativeFeedback </span></span><br><span class="line"><span class="string">                    background=&#123;TouchableNativeFeedback.SelectableBackground()&#125;</span></span><br><span class="line"><span class="string">                    onPress=&#123;this.FeedbackHandler.bind(this)&#125;&gt;</span></span><br><span class="line"><span class="string">                    &lt;View style=&#123;styles.base&#125;&gt;</span></span><br><span class="line"><span class="string">                        &lt;Text style=&#123;styles.baseFont&#125;&gt;原生按钮&lt;/Text&gt;</span></span><br><span class="line"><span class="string">                    &lt;/View&gt;</span></span><br><span class="line"><span class="string">                &lt;/TouchableNativeFeedback&gt;</span></span><br><span class="line"><span class="string">            &lt;/View&gt;</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="string">    base: &#123;</span></span><br><span class="line"><span class="string">        margin: 10,</span></span><br><span class="line"><span class="string">        width: 300,</span></span><br><span class="line"><span class="string">        height: 100,</span></span><br><span class="line"><span class="string">        borderRadius: 5,</span></span><br><span class="line"><span class="string">        backgroundColor: 'green',</span></span><br><span class="line"><span class="string">        justifyContent: 'center',</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    baseFont: &#123;</span></span><br><span class="line"><span class="string">        color: "</span>orange<span class="string">",</span></span><br><span class="line"><span class="string">        textAlign: "</span>center<span class="string">",</span></span><br><span class="line"><span class="string">        lineHeight: 50</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/14/react-native介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/14/react-native介绍/" itemprop="url">react-native介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-14T23:41:33+08:00">
                2019-07-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/14/react-native介绍/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/07/14/react-native介绍/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="移动APP"><a href="#移动APP" class="headerlink" title="移动APP"></a>移动APP</h1><p>移动指的是移动设备平台, <code>app</code> 是应用 (<code>application</code>) 的缩写, 移动App就是移动设备上运行的应用程序</p>
<h2 id="种类划分"><a href="#种类划分" class="headerlink" title="种类划分"></a>种类划分</h2><ul>
<li><strong>WebAPP</strong>:<ul>
<li>网页应用, 需要运行在<code>浏览器</code>环境中, <code>无需</code>安装即可使用</li>
<li>使用纯<code>web</code>技术开发实现</li>
<li>由<code>浏览器</code>负责UI界面的<code>渲染</code></li>
</ul>
</li>
<li><strong>NativeAPP</strong>:<ul>
<li>原生应用, 直接运行在移动<code>设备</code>上, 需要<code>安装</code>后使用</li>
<li>主要采用设备<code>原生语言</code>开发实现, 利用一些新技术可使用<code>其他语言</code>实现部分功能</li>
<li>由移动<code>设备</code>负责UI界面的<code>渲染</code></li>
</ul>
</li>
<li><strong>HybridAPP</strong>:<ul>
<li>混合应用, 直接运行在<code>移动设备</code>上, 需要<code>安装</code>后使用</li>
<li>部分功能采用设备<code>原生语言</code>开发, 部分采用<code>web</code>技术开发</li>
<li><code>原生</code>语言编写的功能由移动<code>设置</code>渲染, <code>web</code>语言编写的功能运行在App内嵌的<code>web容器</code>中(就是一个内嵌的<code>浏览器</code>)</li>
</ul>
</li>
</ul>
<h2 id="运作模式"><a href="#运作模式" class="headerlink" title="运作模式"></a>运作模式</h2><p><img src="https://github.com/guopengfei116/drop/blob/master/img/react-native/app_operational_mode.png?raw=true" alt="移动app运行模式对比"></p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><table>
<thead>
<tr>
<th style="text-align:left">对比/分类</th>
<th style="text-align:center">Web App</th>
<th style="text-align:center">Native App</th>
<th style="text-align:center">Hybrid App</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">市场认可度</td>
<td style="text-align:center">不认</td>
<td style="text-align:center">认可</td>
<td style="text-align:center">认可</td>
</tr>
<tr>
<td style="text-align:left">是否要安装</td>
<td style="text-align:center">否</td>
<td style="text-align:center">是</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:left">开发成本</td>
<td style="text-align:center">低</td>
<td style="text-align:center">高</td>
<td style="text-align:center">中</td>
</tr>
<tr>
<td style="text-align:left">维护更新</td>
<td style="text-align:center">低</td>
<td style="text-align:center">高</td>
<td style="text-align:center">中</td>
</tr>
<tr>
<td style="text-align:left">跨平台</td>
<td style="text-align:center">低</td>
<td style="text-align:center">高</td>
<td style="text-align:center">中</td>
</tr>
<tr>
<td style="text-align:left">体验</td>
<td style="text-align:center">差</td>
<td style="text-align:center">高</td>
<td style="text-align:center">中</td>
</tr>
</tbody>
</table>
<h2 id="进化"><a href="#进化" class="headerlink" title="进化"></a>进化</h2><p>你会发现，Native App 性能体验好，Hybrid App 开发维护成本低。你可能会想，如果有一种技术能够同时拥有两者的优点就好了，facebook 公司的 ReactNative 因此而生，它使用js和React编写UI逻辑，然后生成原生控件进行渲染绘制，既拥有媲美原生应用的性能体验，又拥有混合应用跨平台、开发快等优点。</p>
<p>当然这也不是绝对的，在特殊需求下，还是会有不足。首先框架本身需要处理大量平台相关的逻辑，随着系统与API的升级变化，开发者有可能也需要处理平台之间的差异，甚至有些特性只能在部分平台上实现，从而降低跨平台性。当然，这些问题也会随着 ReactNative 的版本迭代逐渐改善。</p>
<h1 id="WEB技术开发框架"><a href="#WEB技术开发框架" class="headerlink" title="WEB技术开发框架"></a>WEB技术开发框架</h1><h2 id="混合应用"><a href="#混合应用" class="headerlink" title="混合应用"></a>混合应用</h2><h4 id="Ionic"><a href="#Ionic" class="headerlink" title="Ionic"></a>Ionic</h4><ul>
<li>Angular官网 <a href="https://angular.io/" target="_blank" rel="noopener">https://angular.io/</a></li>
<li>Ionic官网 <a href="http://ionicframework.com/" target="_blank" rel="noopener">http://ionicframework.com/</a></li>
<li>Ionic中文网 <a href="http://www.ionic.wang/" target="_blank" rel="noopener">http://www.ionic.wang/</a></li>
<li>Cordova官网 <a href="https://cordova.apache.org/" target="_blank" rel="noopener">https://cordova.apache.org/</a></li>
<li>Cordova中文网 <a href="http://cordova.axuer.com/" target="_blank" rel="noopener">http://cordova.axuer.com/</a></li>
</ul>
<h4 id="Html5"><a href="#Html5" class="headerlink" title="Html5+"></a>Html5+</h4><ul>
<li>官网 <a href="http://www.dcloud.io/" target="_blank" rel="noopener">http://www.dcloud.io/</a></li>
</ul>
<h4 id="AppCan"><a href="#AppCan" class="headerlink" title="AppCan"></a>AppCan</h4><ul>
<li>官网 <a href="http://www.appcan.cn/" target="_blank" rel="noopener">http://www.appcan.cn/</a></li>
</ul>
<h4 id="微信公众号"><a href="#微信公众号" class="headerlink" title="微信公众号"></a>微信公众号</h4><ul>
<li>官网 <a href="https://mp.weixin.qq.com/" target="_blank" rel="noopener">https://mp.weixin.qq.com/</a></li>
<li>其他 <a href="https://my.oschina.net/u/1416844/blog/759209" target="_blank" rel="noopener">https://my.oschina.net/u/1416844/blog/759209</a></li>
</ul>
<h2 id="原生App"><a href="#原生App" class="headerlink" title="原生App"></a>原生App</h2><h4 id="ReactNative"><a href="#ReactNative" class="headerlink" title="ReactNative"></a>ReactNative</h4><ul>
<li>React官网 <a href="https://facebook.github.io/react/" target="_blank" rel="noopener">https://facebook.github.io/react/</a></li>
<li>ReactNative官网 <a href="https://facebook.github.io/react-native/" target="_blank" rel="noopener">https://facebook.github.io/react-native/</a></li>
<li>ReactNative中文网 <a href="https://reactnative.cn/" target="_blank" rel="noopener">https://reactnative.cn/</a></li>
</ul>
<h4 id="Weex"><a href="#Weex" class="headerlink" title="Weex"></a>Weex</h4><ul>
<li>Vue官网 <a href="https://cn.vuejs.org/" target="_blank" rel="noopener">https://cn.vuejs.org/</a></li>
<li>Weex官网 <a href="http://weex.apache.org/cn/" target="_blank" rel="noopener">http://weex.apache.org/cn/</a></li>
<li>WeexGithub <a href="https://github.com/apache/incubator-weex" target="_blank" rel="noopener">https://github.com/apache/incubator-weex</a></li>
</ul>
<h4 id="Flutter"><a href="#Flutter" class="headerlink" title="Flutter"></a>Flutter</h4><ul>
<li>Rlutter官网 <a href="https://flutter.io/" target="_blank" rel="noopener">https://flutter.io/</a></li>
<li>Rlutter中文网 <a href="https://flutterchina.club/" target="_blank" rel="noopener">https://flutterchina.club/</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/08/mobx-react源码之inject/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/08/mobx-react源码之inject/" itemprop="url">mobx-react源码之inject</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-08T00:59:52+08:00">
                2019-04-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/08/mobx-react源码之inject/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/08/mobx-react源码之inject/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>mobx-react的inject方法做了什么？？？</p>
<h1 id="START"><a href="#START" class="headerlink" title="START"></a>START</h1><p>当使用mobx配合react时，对于store的注入，都是inject配合装饰器的方法来使用，Provider是高阶组件，inject函数等于高阶组件，看如下代码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> &#123; inject, observer &#125; <span class="keyword">from</span> <span class="string">'mobx-react'</span></span><br><span class="line"></span><br><span class="line">@inject(<span class="string">'myStore'</span>) @observer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    componentDidMount() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.props.myStore)</span><br><span class="line">    &#125;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                MyComp</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">当Provider注入了mobxStore到组件之后，实际上mobxStore是挂载到this.context中的</span><br><span class="line">inject的作用就是把参数作为key值从mobxStore里取出，this.context.mobxStores[key]</span><br><span class="line">取出之后把组件和取出的值重新生成新的组件(高阶组件)</span><br><span class="line">inject先执行返回一个函数，装饰器再把组件作为参数传给这个返回的函数</span><br></pre></td></tr></table></figure>
<h1 id="inject源码"><a href="#inject源码" class="headerlink" title="inject源码"></a>inject源码</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">inject</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> grabStoresFn</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">arguments</span>[<span class="number">0</span>] === <span class="string">"function"</span>) &#123; <span class="comment">// 如果参数为函数</span></span><br><span class="line">        grabStoresFn = <span class="built_in">arguments</span>[<span class="number">0</span>] <span class="comment">// 直接把参数作为获取store的函数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">componentClass</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> injected = createStoreInjector(grabStoresFn, componentClass) <span class="comment">// 返回Injector组件</span></span><br><span class="line">            injected.isMobxInjector = <span class="literal">false</span></span><br><span class="line">            injected = observer(injected) <span class="comment">// 把新组件作一次observer</span></span><br><span class="line">            injected.isMobxInjector = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">return</span> injected</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果不是函数，即是多个字符串的形式</span></span><br><span class="line">        <span class="keyword">const</span> storeNames = []</span><br><span class="line">        <span class="comment">// 循环字符串参数，放到storeNames数组中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) storeNames[i] = <span class="built_in">arguments</span>[i]</span><br><span class="line">        <span class="comment">// 调用grabStoresByName，返回了匿名函数function(baseStores, nextProps)</span></span><br><span class="line">        grabStoresFn = grabStoresByName(storeNames)</span><br><span class="line">        <span class="comment">// 同理，最后也是返回了Injector组件</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">componentClass</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> createStoreInjector(grabStoresFn, componentClass, storeNames.join(<span class="string">"-"</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="inject方法解析"><a href="#inject方法解析" class="headerlink" title="inject方法解析"></a>inject方法解析</h1><p>1,inject通过arguments来获取参数，所以可以传入多个storeName<br>2,如果传入的fn，就把这个函数当作获取store的函数，接受mobxStore作为参数，返回对象{}<br>3,如果传入的是字符串，先调用一次grabStoresByName</p>
<h1 id="grabStoresByName方法解析"><a href="#grabStoresByName方法解析" class="headerlink" title="grabStoresByName方法解析"></a>grabStoresByName方法解析</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">grabStoresByName</span>(<span class="params">storeNames</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">baseStores, nextProps</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// storeNames是数组，包含了需要的storeName，从context.mobxStores中取出对应值</span></span><br><span class="line">        storeNames.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">storeName</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// storeName不能在props中定义过的</span></span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                storeName <span class="keyword">in</span> nextProps</span><br><span class="line">            )</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="comment">// storeName不能是不存在的属性</span></span><br><span class="line">            <span class="keyword">if</span> (!(storeName <span class="keyword">in</span> baseStores))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">                    <span class="string">"MobX injector: Store '"</span> +</span><br><span class="line">                        storeName +</span><br><span class="line">                        <span class="string">"' is not available! Make sure it is provided by some Provider"</span></span><br><span class="line">                )</span><br><span class="line">            <span class="comment">// 添加需要的属性值</span></span><br><span class="line">            nextProps[storeName] = baseStores[storeName]</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> nextProps</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1,grabStoresByName返回函数，这个函数将在inject()(grabStoresFn)作为参数<br>2,baseStores === context.mobxStores<br>3,如果storeName在props中存在，将会直接返回，不会放到props中，如果storeName不存在，会抛出错误提示</p>
<h1 id="createStoreInjector函数解析"><a href="#createStoreInjector函数解析" class="headerlink" title="createStoreInjector函数解析"></a>createStoreInjector函数解析</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStoreInjector</span>(<span class="params">grabStoresFn, component, injectNames</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 组件名</span></span><br><span class="line">    <span class="keyword">let</span> displayName =</span><br><span class="line">        <span class="string">"inject-"</span> +</span><br><span class="line">        (component.displayName ||</span><br><span class="line">            component.name ||</span><br><span class="line">            (component.constructor &amp;&amp; component.constructor.name) ||</span><br><span class="line">            <span class="string">"Unknown"</span>)</span><br><span class="line">    <span class="keyword">if</span> (injectNames) displayName += <span class="string">"-with-"</span> + injectNames</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Injector</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> displayName = displayName</span><br><span class="line"></span><br><span class="line">        storeRef = <span class="function"><span class="params">instance</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.wrappedInstance = instance</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        render() &#123;</span><br><span class="line">            <span class="keyword">let</span> newProps = &#123;&#125;</span><br><span class="line">            <span class="comment">// 拿到Injector自身props</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> <span class="keyword">this</span>.props)</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.props.hasOwnProperty(key)) &#123;</span><br><span class="line">                    newProps[key] = <span class="keyword">this</span>.props[key]</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// 附加props：@inject(storeName), 获取到this.context.mobxStores[storeName]</span></span><br><span class="line">            <span class="keyword">var</span> additionalProps =</span><br><span class="line">                grabStoresFn(<span class="keyword">this</span>.context.mobxStores || &#123;&#125;, newProps, <span class="keyword">this</span>.context) || &#123;&#125;</span><br><span class="line">            <span class="comment">// 遍历添加新属性值</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> additionalProps) &#123;</span><br><span class="line">                newProps[key] = additionalProps[key]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!isStateless(component)) &#123;</span><br><span class="line">                newProps.ref = <span class="keyword">this</span>.storeRef</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 生成新的DOM：等于&lt;component ...newProps /&gt;  个人理解</span></span><br><span class="line">            <span class="keyword">return</span> createElement(component, newProps)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不作分析，未知其实际作用-- start</span></span><br><span class="line">    hoistStatics(Injector, component)</span><br><span class="line"></span><br><span class="line">    Injector.wrappedComponent = component</span><br><span class="line">    <span class="comment">// end</span></span><br><span class="line">    <span class="comment">// 重要！！！必须有proxiedInjectorProps，Injector才能从父组件拿到context.mobxStores</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperties(Injector, proxiedInjectorProps)</span><br><span class="line">    <span class="keyword">return</span> Injector</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1,displayName将作为组件名字存在<br>2,函数最后返回的是Injector组件<br>3,render返回值：首先把Injector自身props和需要的mobxStores数据全部遍历到newProps中，然后调用createElement生成DOM (createElement属于react源码方法，暂未阅读)<br>4,Injector组件的contextTypes是不允许更改的<br>5,isStateless判断是否是函数组件</p>
<h1 id="为什么Inject可以获取到mobxStores-看如下代码"><a href="#为什么Inject可以获取到mobxStores-看如下代码" class="headerlink" title="为什么Inject可以获取到mobxStores, 看如下代码"></a>为什么Inject可以获取到mobxStores, 看如下代码</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">    &lt;Provider &#123;...rootStore.store&#125;&gt;</span><br><span class="line">        &lt;App /&gt;</span><br><span class="line">    &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">    document.getElementById("root")</span></span><br><span class="line"><span class="regexp">)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ App.js代码</span></span><br><span class="line"><span class="regexp">class App extends Component &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 如果没有这个contextTypes，context将会是一个空对象</span></span><br><span class="line"><span class="regexp">    static contextTypes = &#123;</span></span><br><span class="line"><span class="regexp">        mobxStores: PropTypes.object</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    componentDidMount() &#123;</span></span><br><span class="line"><span class="regexp">        console.log(this.context)</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    render() &#123;</span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">            &lt;div className="App"&gt;</span></span><br><span class="line"><span class="regexp">                app.js</span></span><br><span class="line"><span class="regexp">            &lt;/</span>div&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1,Provider高阶组件定义了getChildContext方法：定义了子组件的context将会返回什么数据<br>2,子组件必须定义contextTypes去获取context中想要的数据，inject方法最终会返回Injector组件，Injector帮你做了这件事，所以在Injector中是可以拿到context的<br><img src="http://cdn.jsprogram.cn/1522138075.png?imageMogr2/thumbnail/!70p"><br>最终逻辑就是Provider定义了context返回数据，Injector拿到了mobxStores，与App组件生成一个带props的新组件</p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1><p>inject等于高阶组件，返回函数，函数的执行返回Injector组件，props的获取从this.context.mobxStores拿到</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/06/React-DOM操作的原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/06/React-DOM操作的原理/" itemprop="url">React DOM操作的原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-06T18:17:01+08:00">
                2019-03-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/06/React-DOM操作的原理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/06/React-DOM操作的原理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="虚拟DOM"><a href="#虚拟DOM" class="headerlink" title="虚拟DOM"></a>虚拟DOM</h1><h2 id="基础的DOM原理"><a href="#基础的DOM原理" class="headerlink" title="基础的DOM原理"></a>基础的DOM原理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">state 数据</span><br><span class="line">JSX 模板</span><br><span class="line">数据 + 模板 结合, 生成真实的DOM, 显示</span><br><span class="line">state 发生改变</span><br><span class="line">数据 + 模板 结合, 生成真实的DOM, 替换原始的DOM</span><br></pre></td></tr></table></figure>
<p>缺陷: DOM片段整个整个替换会很耗性能</p>
<h2 id="改进的DOM原理"><a href="#改进的DOM原理" class="headerlink" title="改进的DOM原理"></a>改进的DOM原理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">state 数据</span><br><span class="line">JSX模板</span><br><span class="line">数据 + 模板 结合, 生成真实的DOM, 显示</span><br><span class="line">state变化</span><br><span class="line">数据 + 模板结合, 生成新的真实的DOM, 并不直接替换原始的DOM</span><br><span class="line">新的DOM (DoucumentFragment文档碎片, 没那么耗性能) 和原始的DOM做对比, 找差异(DOM之间的比较)</span><br><span class="line">找到input 框的变化</span><br><span class="line">只用新的DOM中的input 元素进行替换老元素</span><br></pre></td></tr></table></figure>
<p>缺陷: 全部替换 –&gt; 生成新的DoucumentFragment, DOM之间比较(DOM比对也耗性能) –&gt; 只替换DOM</p>
<h2 id="React的DOM原理"><a href="#React的DOM原理" class="headerlink" title="React的DOM原理"></a>React的DOM原理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">state 数据</span><br><span class="line">JSX模板</span><br><span class="line">数据 + 模板 生成虚拟DOM( 虚拟DOM 本质就是 JS对象 , 用来描述真实的DOM) (减少损耗)</span><br><span class="line">    [<span class="string">'div'</span>, &#123;id: <span class="string">'abc'</span>&#125;, [<span class="string">'span'</span>, &#123;&#125;, <span class="string">'Hello'</span>]]  --&gt; js对象[<span class="string">'标签名'</span>, &#123;属性对象&#125;, 子节点]的嵌套成虚拟DOM树</span><br><span class="line"></span><br><span class="line">用虚拟DOM, 生成真实的DOM, 显示</span><br><span class="line">    &lt;div id=<span class="string">"abc"</span>&gt;&lt;span&gt; Hello &lt;/span&gt;&lt;/div&gt; --&gt; 真实的DOM</span><br><span class="line"></span><br><span class="line">state发生变化</span><br><span class="line">数据 + 模板 生成新的虚拟DOM, 只是比较 js对象 的差异, 进行改变(极大的提示性能)</span><br><span class="line">    [<span class="string">'div'</span>, &#123;id: <span class="string">'abc'</span>&#125;, [<span class="string">'span'</span>, &#123;&#125;, <span class="string">'Bye'</span>]]</span><br><span class="line"></span><br><span class="line">比较虚拟DOM(也即JS对象) 的差别</span><br><span class="line">直接操作DOM, 改变span 中的内容</span><br></pre></td></tr></table></figure>
<p>改进: 整个DOM的替换 -&gt; 生成新的DOM(DocumentFragement), 比较DOM, 替换DOM -&gt; 生成虚拟DOM(JS对象), 比较虚拟DOM(比较js对象), 替换DOM</p>
<p>优点:<br>    1,性能提升<br>    2,虚拟DOM 使得跨端应用得以实现, React Native, 虚拟DOM本身是js对象(web, 原生应用都可以识别), 网页里面渲染成DOM, 原生里面渲染成原生组件</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/25/node-异步和同步处理过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/25/node-异步和同步处理过程/" itemprop="url">node 异步和同步处理过程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-25T11:35:55+08:00">
                2019-02-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/25/node-异步和同步处理过程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/25/node-异步和同步处理过程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/21/node-puppeteer模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/21/node-puppeteer模块/" itemprop="url">node puppeteer模块</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-21T16:57:06+08:00">
                2019-02-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/21/node-puppeteer模块/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/21/node-puppeteer模块/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="关于puppeteer"><a href="#关于puppeteer" class="headerlink" title="关于puppeteer"></a>关于puppeteer</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">puppeteer是一个node库，他提供了一组用来操纵Chrome的API（默认headless也就是无UI的chrome，也可以配置为有UI）</span><br><span class="line"></span><br><span class="line">有点类似于PhantomJS，但Puppeteer是Chrome官方团队进行维护的，前景更好。</span><br></pre></td></tr></table></figure>
<h2 id="puppeteer可以做什么"><a href="#puppeteer可以做什么" class="headerlink" title="puppeteer可以做什么?"></a>puppeteer可以做什么?</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">利用网页生成PDF、图片</span><br><span class="line">爬取SPA应用，并生成预渲染内容（即“SSR” 服务端渲染）</span><br><span class="line">可以从网站抓取内容</span><br><span class="line">自动化表单提交、UI测试、键盘输入等</span><br><span class="line">帮你创建一个最新的自动化测试环境（chrome），可以直接在此运行测试用例</span><br><span class="line">捕获站点的时间线，以便追踪你的网站，帮助分析网站性能问题</span><br></pre></td></tr></table></figure>
<p>安装:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i puppeteer --save</span><br></pre></td></tr></table></figure></p>
<h1 id="小试牛刀-生成网页截图"><a href="#小试牛刀-生成网页截图" class="headerlink" title="小试牛刀-生成网页截图"></a>小试牛刀-生成网页截图</h1><p>puppeteer安装完成之后，我们先来个小demo练练手，对指定网站进行截图，拿baidu网试试吧。创建screenshot.js文件，贴入以下代码。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载先前安装的 puppeteer</span></span><br><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getPic</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建chrome实例</span></span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch()</span><br><span class="line">  <span class="comment">// 打开一个新的选项卡</span></span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">  <span class="comment">// 设置页面宽高</span></span><br><span class="line">  page.setViewport(&#123;</span><br><span class="line">    width: <span class="number">1920</span>,</span><br><span class="line">    height: <span class="number">2000</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 在我们创建的这个选项卡下，转到baidu网首页</span></span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">'http://www.baidu.com'</span>)</span><br><span class="line">  <span class="comment">// 在当前目录下生成nd.png截图</span></span><br><span class="line">  <span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>: <span class="string">'nd.png'</span>&#125;)</span><br><span class="line">  <span class="comment">// 最后，关闭浏览器</span></span><br><span class="line">  <span class="keyword">await</span> browser.close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getPic()</span><br></pre></td></tr></table></figure></p>
<h1 id="爬虫实践"><a href="#爬虫实践" class="headerlink" title="爬虫实践"></a>爬虫实践</h1><p>我们可以轻易地想到，puppeteer功能如此强大，用来做爬虫是再好不过了。接下来的内容也是我自己的实践:网易云音乐的歌曲下面总是有各种各样的神评论，所以我打算用puppeteer来收集一下云音乐的评论。</p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>我们的需求是输入一个音乐人的主页链接，收集这个音乐人下的所有热门单曲的所有评论。例如音乐人赵雷的主页下有47首热门单曲，他的主页是<a href="http://music.163.com/#/artist?id=6731，接下来我们一步一步实现。" target="_blank" rel="noopener">http://music.163.com/#/artist?id=6731，接下来我们一步一步实现。</a></p>
<h2 id="分析音乐人主页的DOM结构"><a href="#分析音乐人主页的DOM结构" class="headerlink" title="分析音乐人主页的DOM结构"></a>分析音乐人主页的DOM结构</h2><p>我们发现主页的整个页面是由一个iframe包裹的，iframe中有一个id是song-list-pre-cache的div，该div下有一个table，table下的每一个a标签，就是每一首歌的url以及歌名了。</p>
<h2 id="获取主页歌曲列表"><a href="#获取主页歌曲列表" class="headerlink" title="获取主页歌曲列表"></a>获取主页歌曲列表</h2><p>这一步开始前，我们先分析一下具体操作步骤：打开音乐人主页-&gt;取到对应iframe-&gt;取到id为song-list-pre-cache的节点-&gt;遍历所有的a标签节点-&gt;取到歌曲的url和名称。</p>
<p>关于分析DOM结构，我这里使用cheerio，其简介为“为服务器特别定制的，快速、灵活的jQuery核心实现”。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>)</span><br><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>)</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> host = <span class="string">'http://music.163.com/#'</span></span><br><span class="line"></span><br><span class="line">puppeteer</span><br><span class="line">    .launch(&#123;<span class="attr">headless</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    .then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">        page.setViewport(&#123;<span class="attr">width</span>: <span class="number">1367</span>, <span class="attr">height</span>: <span class="number">768</span>&#125;)</span><br><span class="line">        <span class="comment">// 在网络连接数为0时，再进行下一步操作，确保页面加载完成</span></span><br><span class="line">        <span class="keyword">await</span> page.goto(<span class="string">`<span class="subst">$&#123;host&#125;</span>/artist?id=6731`</span>, &#123;<span class="attr">waitUntil</span>: <span class="string">'networkidle0'</span>&#125;)</span><br><span class="line">        <span class="keyword">const</span> frames = <span class="keyword">await</span> page.frames()</span><br><span class="line">        <span class="comment">// 取到目标iframe</span></span><br><span class="line">        <span class="keyword">const</span> targetFrame = frames.find(<span class="function"><span class="params">frame</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> frame.name() === <span class="string">'contentFrame'</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> content = <span class="keyword">await</span> targetFrame.content()</span><br><span class="line">        <span class="keyword">let</span> $ = cheerio.load(content)</span><br><span class="line">        <span class="keyword">const</span> $list = $(<span class="string">'#song-list-pre-cache'</span>)</span><br><span class="line">        <span class="comment">// 遍历a标签，并取到其中的对应属性，作为歌曲的链接和名称</span></span><br><span class="line">        <span class="keyword">const</span> songList = $list</span><br><span class="line">            .find(<span class="string">'a'</span>)</span><br><span class="line">            .map(<span class="function">(<span class="params">i, elem</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> href = $(elem).attr(<span class="string">'href'</span>)</span><br><span class="line">                <span class="keyword">if</span> (_.startsWith(href, <span class="string">'/song?id='</span>)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> title = $(elem).find(<span class="string">'b'</span>).attr(<span class="string">'title'</span>)</span><br><span class="line">                    <span class="keyword">return</span> &#123;href, title&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .get()</span><br><span class="line">        <span class="comment">// 打印歌曲列表</span></span><br><span class="line">        <span class="built_in">console</span>.log(songList)</span><br><span class="line">        <span class="keyword">await</span> browser.close()</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[ &#123; <span class="attr">href</span>: <span class="string">'/song?id=436514312'</span>, <span class="attr">title</span>: <span class="string">'成都'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202373'</span>, <span class="attr">title</span>: <span class="string">'南方姑娘'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567189'</span>, <span class="attr">title</span>: <span class="string">'理想'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567193'</span>, <span class="attr">title</span>: <span class="string">'我们的时光'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202369'</span>, <span class="attr">title</span>: <span class="string">'画'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567192'</span>, <span class="attr">title</span>: <span class="string">'少年锦时'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=447925059'</span>, <span class="attr">title</span>: <span class="string">'阿刁 - (Diao)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=447926067'</span>, <span class="attr">title</span>: <span class="string">'鼓楼 - (The Drum Tower)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567191'</span>, <span class="attr">title</span>: <span class="string">'三十岁的女人'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=447925066'</span>, <span class="attr">title</span>: <span class="string">'八十年代的歌 - (Song Of The 80s)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=33166602'</span>, <span class="attr">title</span>: <span class="string">'让我偷偷看你'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=447926063'</span>, <span class="attr">title</span>: <span class="string">'朵 - (Dorr)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=437608773'</span>, <span class="attr">title</span>: <span class="string">'无法长大'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=530995556'</span>, <span class="attr">title</span>: <span class="string">'十九岁 - (At The Age of Nineteen)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567187'</span>, <span class="attr">title</span>: <span class="string">'吉姆餐厅'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=447925058'</span>, <span class="attr">title</span>: <span class="string">'玛丽 - (Mary)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=1295824647'</span>, <span class="attr">title</span>: <span class="string">'彩虹下面 - (电影《西虹市首富》推广曲)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567188'</span>, <span class="attr">title</span>: <span class="string">'家乡'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=28111471'</span>, <span class="attr">title</span>: <span class="string">'已是两条路上的人'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=517567264'</span>, <span class="attr">title</span>: <span class="string">'静下来'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202368'</span>, <span class="attr">title</span>: <span class="string">'未给姐姐递出的信'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567190'</span>, <span class="attr">title</span>: <span class="string">'梦中的哈德森'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567185'</span>, <span class="attr">title</span>: <span class="string">'北京的冬天'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=34852810'</span>, <span class="attr">title</span>: <span class="string">'再也不会去丽江'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=447925067'</span>, <span class="attr">title</span>: <span class="string">'再见北京 - (Goodbye! Beijing!)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567194'</span>, <span class="attr">title</span>: <span class="string">'小屋'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202367'</span>, <span class="attr">title</span>: <span class="string">'人家'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202377'</span>, <span class="attr">title</span>: <span class="string">'妈妈'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202376'</span>, <span class="attr">title</span>: <span class="string">'背影'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=447925063'</span>, <span class="attr">title</span>: <span class="string">'孤独 - (Left Alone)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29567186'</span>, <span class="attr">title</span>: <span class="string">'浮游'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202370'</span>, <span class="attr">title</span>: <span class="string">'不开的唇'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202375'</span>, <span class="attr">title</span>: <span class="string">'开往北京的火车'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=447926068'</span>, <span class="attr">title</span>: <span class="string">'窑上路 - (Yao-shang Road)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202371'</span>, <span class="attr">title</span>: <span class="string">'赵小雷'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=29810320'</span>, <span class="attr">title</span>: <span class="string">'未给姐姐递出的信 '</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=433018041'</span>, <span class="attr">title</span>: <span class="string">'民谣'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=202374'</span>, <span class="attr">title</span>: <span class="string">'Over'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=553546118'</span>, <span class="attr">title</span>: <span class="string">'朵儿 (Live版)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=1327930869'</span>, <span class="attr">title</span>: <span class="string">'1三十岁的女人（Cover：赵雷）'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=460628183'</span>, <span class="attr">title</span>: <span class="string">'月亮粑粑 (Live)'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=432792901'</span>, <span class="attr">title</span>: <span class="string">'凭什么说爱你'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=433018045'</span>, <span class="attr">title</span>: <span class="string">'往事只能回味'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=31460216'</span>, <span class="attr">title</span>: <span class="string">'米店'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=432792905'</span>, <span class="attr">title</span>: <span class="string">'夏天'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=433018044'</span>, <span class="attr">title</span>: <span class="string">'爱人你在哪里'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=433018046'</span>, <span class="attr">title</span>: <span class="string">'逆流而上'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=433018047'</span>, <span class="attr">title</span>: <span class="string">'飞来飞去'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=432792903'</span>, <span class="attr">title</span>: <span class="string">'塔吉汗'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">href</span>: <span class="string">'/song?id=432792904'</span>, <span class="attr">title</span>: <span class="string">'何必'</span> &#125; ]</span><br></pre></td></tr></table></figure>
<h2 id="跳转到歌曲页面"><a href="#跳转到歌曲页面" class="headerlink" title="跳转到歌曲页面"></a>跳转到歌曲页面</h2><p>在上一步，我们拿到了歌曲的url，那么接下来自然就是跳转到每首歌的页面，进行评论抓取了。</p>
<p>歌曲页面的DOM结构和音乐人页面很类似，也有一个iframe，iframe中有一个id为comment-box的div节点，在这个节点在遍历class为itm的div节点，在itm下，通过具体分析，我们就能取到用户名和评论内容了。关于热评和最新评论，我们先简单处理，不区分。</p>
<p>我们将每首歌第一页的评论都写在content.html文件中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>)</span><br><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>)</span><br><span class="line"><span class="keyword">const</span> he = <span class="built_in">require</span>(<span class="string">'he'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> host = <span class="string">'http://music.163.com/#'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象出抓取评论的函数，便于进一步开发</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; sTargetFrame </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> collectCommentList = <span class="keyword">async</span>(sTargetFrame) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> sContent = <span class="keyword">await</span> sTargetFrame.content()</span><br><span class="line">    <span class="keyword">const</span> $ = cheerio.load(sContent)</span><br><span class="line">    <span class="keyword">const</span> res = $(<span class="string">'#comment-box'</span>)</span><br><span class="line">        .find(<span class="string">'.itm'</span>)</span><br><span class="line">        .map(<span class="function">(<span class="params">i, elem</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> brk = $(elem).find(<span class="string">'.cntwrap .f-brk'</span>)</span><br><span class="line">            <span class="keyword">const</span> brkText = brk.text()</span><br><span class="line">            <span class="comment">// 用户名</span></span><br><span class="line">            <span class="keyword">const</span> username = $(brk)</span><br><span class="line">                .find(<span class="string">'a'</span>)</span><br><span class="line">                .text()</span><br><span class="line">            <span class="comment">// 评论字符串</span></span><br><span class="line">            <span class="keyword">const</span> commentStr = $(brk)</span><br><span class="line">                .text()</span><br><span class="line">                .replace(username, <span class="string">''</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;username, commentStr&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .get()</span><br><span class="line">    fs.appendFileSync(<span class="string">'./song.txt'</span>, <span class="built_in">JSON</span>.stringify(res) + <span class="string">'\n'</span>, err =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">puppeteer</span><br><span class="line">    .launch(&#123;<span class="attr">headless</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    .then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">        page.setViewport(&#123;<span class="attr">width</span>: <span class="number">1367</span>, <span class="attr">height</span>: <span class="number">768</span>&#125;)</span><br><span class="line">        <span class="keyword">await</span> page.goto(<span class="string">`<span class="subst">$&#123;host&#125;</span>/artist?id=6731`</span>, &#123;<span class="attr">waitUntil</span>: <span class="string">'networkidle0'</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> frames = <span class="keyword">await</span> page.frames()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> targetFrame = frames.find(<span class="function"><span class="params">frame</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> frame.name() === <span class="string">'contentFrame'</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> content = <span class="keyword">await</span> targetFrame.content()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> $ = cheerio.load(content)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> $list = $(<span class="string">'#song-list-pre-cache'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> songList = $list</span><br><span class="line">            .find(<span class="string">'a'</span>)</span><br><span class="line">            .map(<span class="function">(<span class="params">i, elem</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> href = $(elem).attr(<span class="string">'href'</span>)</span><br><span class="line">                <span class="keyword">if</span> (_.startsWith(href, <span class="string">'/song?id='</span>)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> title = $(elem).find(<span class="string">'b'</span>).attr(<span class="string">'title'</span>)</span><br><span class="line">                    <span class="keyword">return</span> &#123;href, title&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .get()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">let</span> songItem</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`一共<span class="subst">$&#123;songList.length&#125;</span>首歌`</span>)</span><br><span class="line">        <span class="keyword">while</span> (songItem = songList[index++]) &#123;</span><br><span class="line">            <span class="keyword">const</span> sPage = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`正在收集<span class="subst">$&#123;songItem.title&#125;</span>下的评论`</span>)</span><br><span class="line">            <span class="keyword">await</span> sPage.goto(<span class="string">`<span class="subst">$&#123;host&#125;</span><span class="subst">$&#123;songItem.href&#125;</span>`</span>, &#123;</span><br><span class="line">                waitUntil: <span class="string">'networkidle2'</span>,</span><br><span class="line">                timeout: <span class="number">0</span></span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">const</span> sFrames = <span class="keyword">await</span> sPage.frames()</span><br><span class="line">            <span class="keyword">const</span> sTargetFrame = sFrames.find(<span class="function"><span class="params">frame</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> frame.name() === <span class="string">'contentFrame'</span></span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> commentList = <span class="keyword">await</span> collectCommentList(sTargetFrame)</span><br><span class="line"></span><br><span class="line">            sPage.close()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> browser.close()</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p>到此为止，我们已经可以抓取每一首歌的第一页评论了，但是这远远不够，一首热门歌曲往往有上万条评论，这就需要翻页抓取了。</p>
<h2 id="评论翻页"><a href="#评论翻页" class="headerlink" title="评论翻页"></a>评论翻页</h2><p>puppeteer功能强大，模拟按钮点击功能当然也不在话下。所以我们接下来要做的事情就是点击下一页按钮后，再重复一次抓取动作即可。</p>
<p>避免篇幅过大，我这里贴出主要的翻页代码，完整代码会在文末给出。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> commentList = <span class="keyword">await</span> collectCommentList(sTargetFrame)</span><br><span class="line">  <span class="keyword">let</span> nextBtnHandler = <span class="keyword">await</span> sTargetFrame.$(<span class="string">'.znxt'</span>)</span><br><span class="line">  <span class="keyword">if</span> (!nextBtnHandler) &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  nextBtnHandler.click()</span><br><span class="line">  <span class="comment">// 关于如何判断评论加载完成，这里还没有找到更好的方案，所以暂时做一个 sleep 处理</span></span><br><span class="line">  <span class="keyword">await</span> timeout(<span class="number">1500</span>)</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="keyword">await</span> isBtnAbled(sTargetFrame))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> commentList = <span class="keyword">await</span> collectCommentList(sTargetFrame)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isBtnAbled = <span class="keyword">async</span>(sTargetFrame, className) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> sContent = <span class="keyword">await</span> sTargetFrame.content()</span><br><span class="line">    <span class="keyword">const</span> $ = cheerio.load(sContent)</span><br><span class="line">    <span class="keyword">return</span> !$(<span class="string">'.znxt'</span>).hasClass(<span class="string">'js-disabled'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">timeout</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> setTimeout(resolve, ms))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="项目代码"><a href="#项目代码" class="headerlink" title="项目代码"></a>项目代码</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>);</span><br><span class="line"><span class="keyword">const</span> he = <span class="built_in">require</span>(<span class="string">'he'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> host = <span class="string">'http://music.163.com/#'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> collectCommentList = <span class="keyword">async</span>(sTargetFrame) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> sContent = <span class="keyword">await</span> sTargetFrame.content();</span><br><span class="line">    <span class="keyword">const</span> $ = cheerio.load(sContent);</span><br><span class="line">    <span class="keyword">const</span> res = $(<span class="string">'#comment-box'</span>).find(<span class="string">'.itm'</span>).map(<span class="function">(<span class="params">i, elem</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> brk = $(elem).find(<span class="string">'.cntwrap .f-brk'</span>);</span><br><span class="line">        <span class="keyword">const</span> brkText = he.decode(brk.text());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户名</span></span><br><span class="line">        <span class="keyword">const</span> username = $(brk)</span><br><span class="line">            .find(<span class="string">'a'</span>)</span><br><span class="line">            .text();</span><br><span class="line">        <span class="comment">// 评论字符串</span></span><br><span class="line">        <span class="keyword">const</span> commentStr = $(brk)</span><br><span class="line">            .text()</span><br><span class="line">            .replace(username, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123; username, commentStr &#125;;</span><br><span class="line">    &#125;).get();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(res))</span><br><span class="line">    fs.appendFileSync(<span class="string">'./song.txt'</span>, <span class="built_in">JSON</span>.stringify(res) + <span class="string">'\n'</span>, err =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isBtnAbled = <span class="keyword">async</span>(sTargetFrame, className) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> sContent = <span class="keyword">await</span> sTargetFrame.content();</span><br><span class="line">    <span class="keyword">const</span> $ = cheerio.load(sContent);</span><br><span class="line">    <span class="keyword">return</span> !$(<span class="string">'.znxt'</span>).hasClass(<span class="string">'js-disabled'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">timeout</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> setTimeout(resolve, ms));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// args: ['--no-sandbox'] ubuntu下启动失败的问题</span></span><br><span class="line">puppeteer</span><br><span class="line">    .launch(&#123; <span class="attr">headless</span>: <span class="literal">true</span>, <span class="attr">args</span>: [<span class="string">'--no-sandbox'</span>] &#125;)</span><br><span class="line">    .then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">        page.setViewport(&#123; <span class="attr">width</span>: <span class="number">1367</span>, <span class="attr">height</span>: <span class="number">768</span> &#125;);</span><br><span class="line">        <span class="keyword">await</span> page.goto(<span class="string">`<span class="subst">$&#123;host&#125;</span>/artist?id=6731`</span>, &#123; <span class="attr">waitUntil</span>: <span class="string">'networkidle0'</span> &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> frames = <span class="keyword">await</span> page.frames();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> targetFrame = frames.find(<span class="function"><span class="params">frame</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> frame.name() === <span class="string">'contentFrame'</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> content = <span class="keyword">await</span> targetFrame.content();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> $ = cheerio.load(content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> $list = $(<span class="string">'#song-list-pre-cache'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> songList = $list.find(<span class="string">'a'</span>).map(<span class="function">(<span class="params">i, elem</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> href = $(elem).attr(<span class="string">'href'</span>);</span><br><span class="line">            <span class="keyword">if</span> (_.startsWith(href, <span class="string">'/song?id='</span>)) &#123;</span><br><span class="line">                <span class="keyword">const</span> title = he.decode($(elem).find(<span class="string">'b'</span>).attr(<span class="string">'title'</span>));</span><br><span class="line">                <span class="keyword">return</span> &#123; href, title &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> songItem;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`一共<span class="subst">$&#123;songList.length&#125;</span>首歌`</span>);</span><br><span class="line">        <span class="keyword">while</span> (songItem = songList[index++]) &#123;</span><br><span class="line">            <span class="keyword">const</span> sPage = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`正在收集<span class="subst">$&#123;songItem.title&#125;</span>下的评论`</span>);</span><br><span class="line">            <span class="keyword">await</span> sPage.goto(<span class="string">`<span class="subst">$&#123;host&#125;</span><span class="subst">$&#123;songItem.href&#125;</span>`</span>, &#123;</span><br><span class="line">                waitUntil: <span class="string">'networkidle2'</span>,</span><br><span class="line">                timeout: <span class="number">0</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">const</span> sFrames = <span class="keyword">await</span> sPage.frames();</span><br><span class="line">            <span class="keyword">const</span> sTargetFrame = sFrames.find(<span class="function"><span class="params">frame</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> frame.name() === <span class="string">'contentFrame'</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> commentList = <span class="keyword">await</span> collectCommentList(sTargetFrame);</span><br><span class="line">                <span class="keyword">let</span> nextBtnHandler = <span class="keyword">await</span> sTargetFrame.$(<span class="string">'.znxt'</span>);</span><br><span class="line">                <span class="keyword">if</span> (!nextBtnHandler) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                nextBtnHandler.click();</span><br><span class="line">                <span class="keyword">await</span> timeout(<span class="number">1500</span>);</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="keyword">await</span> isBtnAbled(sTargetFrame));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> commentList = <span class="keyword">await</span> collectCommentList(sTargetFrame);</span><br><span class="line"></span><br><span class="line">            sPage.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> browser.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fs.appendFile('./content.html', JSON.stringify(songList), (err) =&gt; &#123;</span></span><br><span class="line">        <span class="comment">// console.log(err); &#125;); other actions... await browser.close();</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/21/node-superagent模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/21/node-superagent模块/" itemprop="url">node superagent模块</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-21T15:48:59+08:00">
                2019-02-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/21/node-superagent模块/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/21/node-superagent模块/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SuperAgent"><a href="#SuperAgent" class="headerlink" title="SuperAgent"></a>SuperAgent</h1><p>superagent 是一个轻量的,渐进式的ajax api,可读性好,学习曲线低,内部依赖nodejs原生的请求api,适用于nodejs环境下.</p>
<p>安装:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i superagent --save</span><br></pre></td></tr></table></figure></p>
<p>一个简单的post请求，并设置请求头信息的例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">   .post(<span class="string">'/api/pet'</span>)</span><br><span class="line">   .send(&#123; <span class="attr">name</span>: <span class="string">'Manny'</span>, <span class="attr">species</span>: <span class="string">'cat'</span> &#125;)</span><br><span class="line">   .set(<span class="string">'X-API-Key'</span>, <span class="string">'foobar'</span>)</span><br><span class="line">   .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">   .end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (res.ok) &#123;</span><br><span class="line">       alert(<span class="string">'yay got '</span> + <span class="built_in">JSON</span>.stringify(res.body));</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       alert(<span class="string">'Oh no! error '</span> + res.text);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="请求基础"><a href="#请求基础" class="headerlink" title="请求基础"></a>请求基础</h2><p>一个请求的初始化可以用请求对象里合适的方法来执行，然后调用end()来发送请求,下面是一个简单的get请求:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.get(<span class="string">'/search'</span>).end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>请求方法也可以通过参数传递:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request(<span class="string">'GET'</span>, <span class="string">'/search'</span>).end(callback);</span><br></pre></td></tr></table></figure>
<p>node客户端也允许提供绝对路径:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.get(<span class="string">'http://example.com/search'</span>).end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>delete,head,post,put和别的http动作都可以使用,来换个方法看看:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.head(<span class="string">'/favicon.ico'</span>).end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>delete是一个特列,因为它是系统保留的关键字,所以应该用.del()这个名字:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.del(<span class="string">'/user/1'</span>).end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>http请求默认的方法为get,所以就像你看到的,下面的这个例子也是可用的:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request(<span class="string">'/search'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123; &#125;);</span><br></pre></td></tr></table></figure></p>
<h1 id="设置头字段"><a href="#设置头字段" class="headerlink" title="设置头字段"></a>设置头字段</h1><p>设置头字段非常简单，只需调用.set()方法，传递一个名称和值就行:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">   .get(<span class="string">'/search'</span>)</span><br><span class="line">   .set(<span class="string">'API-Key'</span>, <span class="string">'foobar'</span>)</span><br><span class="line">   .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">   .end(callback);</span><br></pre></td></tr></table></figure>
<p>一次就可以修改多个头字段:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">   .get(<span class="string">'/search'</span>)</span><br><span class="line">   .set(&#123; <span class="string">'API-Key'</span>: <span class="string">'foobar'</span>, <span class="attr">Accept</span>: <span class="string">'application/json'</span> &#125;)</span><br><span class="line">   .end(callback);</span><br></pre></td></tr></table></figure></p>
<h1 id="Get请求"><a href="#Get请求" class="headerlink" title="Get请求"></a>Get请求</h1><p>当使用get请求传递查询字符串的时候，用.query()方法,传递一个对象就可以,下面的代码将产生一个/search?query=Manny&amp;range=1..5&amp;order=desc请求:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">   .get(<span class="string">'/search'</span>)</span><br><span class="line">   .query(&#123; <span class="attr">query</span>: <span class="string">'Manny'</span> &#125;)</span><br><span class="line">   .query(&#123; <span class="attr">range</span>: <span class="string">'1..5'</span> &#125;)</span><br><span class="line">   .query(&#123; <span class="attr">order</span>: <span class="string">'desc'</span> &#125;)</span><br><span class="line">   .end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>或者传一个单独的大对象:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">  .get(<span class="string">'/search'</span>)</span><br><span class="line">  .query(&#123; <span class="attr">query</span>: <span class="string">'Manny'</span>, <span class="attr">range</span>: <span class="string">'1..5'</span>, <span class="attr">order</span>: <span class="string">'desc'</span> &#125;)</span><br><span class="line">  .end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>.query()方法也允许传递字符串:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'/querystring'</span>)</span><br><span class="line">    .query(<span class="string">'search=Manny&amp;range=1..5'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>或者字符串拼接:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'/querystring'</span>)</span><br><span class="line">    .query(<span class="string">'search=Manny'</span>)</span><br><span class="line">    .query(<span class="string">'range=1..5'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="POST-PUT请求"><a href="#POST-PUT请求" class="headerlink" title="POST/PUT请求"></a>POST/PUT请求</h1><p>一个典型的json post请求看起来就像下面的那样，设置一个合适的Content-type头字段，然后写入一些数据，在这个例子里只是json字符串:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request.post(<span class="string">'/user'</span>)</span><br><span class="line">    .set(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">    .send(<span class="string">'&#123;"name":"tj","pet":"tobi"&#125;'</span>)</span><br><span class="line">    .end(callback)</span><br></pre></td></tr></table></figure></p>
<p>因为json非常通用，所以就作为默认的Content-type,下面的例子跟上面的一样:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.post(<span class="string">'/user'</span>)</span><br><span class="line">    .send(&#123; <span class="attr">name</span>: <span class="string">'tj'</span>, <span class="attr">pet</span>: <span class="string">'tobi'</span> &#125;)</span><br><span class="line">    .end(callback)</span><br></pre></td></tr></table></figure></p>
<p>或者调用多次.send()方法:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request.post(<span class="string">'/user'</span>)</span><br><span class="line">    .send(&#123; <span class="attr">name</span>: <span class="string">'tj'</span> &#125;)</span><br><span class="line">    .send(&#123; <span class="attr">pet</span>: <span class="string">'tobi'</span> &#125;)</span><br><span class="line">    .end(callback)</span><br></pre></td></tr></table></figure></p>
<p>默认发送字符串，将设置Content-type为application/x-www-form-urlencoded,多次调用将会通过&amp;来连接，这里的结果为name=tj&amp;pet=tobi:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request.post(<span class="string">'/user'</span>)</span><br><span class="line">    .send(<span class="string">'name=tj'</span>)</span><br><span class="line">    .send(<span class="string">'pet=tobi'</span>)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<p>superagent的请求数据格式化是可以扩展的，不过默认支持form和json两种格式,想发送数据以application/x-www-form-urlencoded类型的话，则可以简单的调用.type()方法传递form参数就行，这里默认是json,下面的请求将会postname=tj&amp;pet=tobi内容:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request.post(<span class="string">'/user'</span>)</span><br><span class="line">    .type(<span class="string">'form'</span>)</span><br><span class="line">    .send(&#123; <span class="attr">name</span>: <span class="string">'tj'</span> &#125;)</span><br><span class="line">    .send(&#123; <span class="attr">pet</span>: <span class="string">'tobi'</span> &#125;)</span><br><span class="line">    .end(callback)</span><br></pre></td></tr></table></figure></p>
<p>注意:form是form-data和urlencoded的别名,为了向后兼容</p>
<h1 id="设置Content-Type"><a href="#设置Content-Type" class="headerlink" title="设置Content-Type"></a>设置Content-Type</h1><p>常见的方案是使用.set()方法:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.post(<span class="string">'/user'</span>).set(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>)</span><br></pre></td></tr></table></figure></p>
<p>一个简便的方法是调用.type()方法，传递一个规范的MIME名称，包括type/subtype,或者一个简单的后缀就像xml,json,png这样，例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.post(<span class="string">'/user'</span>).type(<span class="string">'application/json'</span>)</span><br><span class="line">request.post(<span class="string">'/user'</span>).type(<span class="string">'json'</span>)</span><br><span class="line">request.post(<span class="string">'/user'</span>).type(<span class="string">'png'</span>)</span><br></pre></td></tr></table></figure>
<h1 id="设置接受类型"><a href="#设置接受类型" class="headerlink" title="设置接受类型"></a>设置接受类型</h1><p>跟.type()简便方法一样，这里也可以调用.accept()方法来设置接受类型，这个值将会被request.types所引用，支持传递一个规范的MIME名称，包括type/subtype,或者一个简单的后缀就像xml,json,png这样,例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.get(<span class="string">'/user'</span>).accept(<span class="string">'application/json'</span>)</span><br><span class="line">request.get(<span class="string">'/user'</span>).accept(<span class="string">'json'</span>)</span><br><span class="line">request.get(<span class="string">'/user'</span>).accept(<span class="string">'png'</span>)</span><br></pre></td></tr></table></figure>
<h1 id="查询字符串"><a href="#查询字符串" class="headerlink" title="查询字符串"></a>查询字符串</h1><p>当用.send(obj)方法来发送一个post请求，并且希望传递一些查询字符串，可以调用.query()方法,比如向?format=json&amp;dest=/login发送post请求:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">  .post(<span class="string">'/'</span>)</span><br><span class="line">  .query(&#123; <span class="attr">format</span>: <span class="string">'json'</span> &#125;)</span><br><span class="line">  .query(&#123; <span class="attr">dest</span>: <span class="string">'/login'</span> &#125;)</span><br><span class="line">  .send(&#123; <span class="attr">post</span>: <span class="string">'data'</span>, <span class="attr">here</span>: <span class="string">'wahoo'</span> &#125;)</span><br><span class="line">  .end(callback);</span><br></pre></td></tr></table></figure></p>
<h1 id="解析响应内容"><a href="#解析响应内容" class="headerlink" title="解析响应内容"></a>解析响应内容</h1><p>superagent会解析一些常用的格式给请求者，当前支持application/x-www-form-urlencoded,application/json,multipart/form-data.</p>
<h1 id="JSON-Urlencoded"><a href="#JSON-Urlencoded" class="headerlink" title="JSON/Urlencoded"></a>JSON/Urlencoded</h1><p>res.body是解析后的内容对象,比如一个请求响应’{“user”:{“name”:”tobi”}}’字符串,res.body.user.name将会返回tobi,同样的，x-www-form-urlencoded格式的user[name]=tobi解析完的值，也是一样的.</p>
<h1 id="Multipart"><a href="#Multipart" class="headerlink" title="Multipart"></a>Multipart</h1><p>nodejs客户端通过Formidable模块来支持multipart/form-data类型,当解析一个multipart响应时,res.files属性就可以用.假设一个请求响应下面的数据:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--whoop</span><br><span class="line">Content-Disposition: attachment; name=<span class="string">"image"</span>; filename=<span class="string">"tobi.png"</span></span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line">... data here ...</span><br><span class="line">--whoop</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"name"</span></span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">Tobi</span><br><span class="line">--whoop--</span><br></pre></td></tr></table></figure>
<p>你将可以获取到res.body.name名为’Tobi’,res.files.image为一个file对象,包括一个磁盘文件路径，文件名称，还有其它的文件属性.</p>
<h1 id="响应属性"><a href="#响应属性" class="headerlink" title="响应属性"></a>响应属性</h1><p>响应一般会提供很多有用的标识以及属性,都在response对象里，按照respone.text,解析后的response.body,头字段，一些标识的顺序来排列.</p>
<h1 id="Response-text"><a href="#Response-text" class="headerlink" title="Response text"></a>Response text</h1><p>res.text包含未解析前的响应内容，一般只在mime类型能够匹配text/,json,x-www-form-urlencoding的情况下，默认为nodejs客户端提供,这是为了节省内存.因为当响应以文件或者图片大内容的情况下影响性能.</p>
<h1 id="Response-body"><a href="#Response-body" class="headerlink" title="Response body"></a>Response body</h1><p>跟请求数据自动序列化一样，响应数据也会自动的解析，当为一个Content-Type定义一个解析器后，就能自动解析，默认解析包含application/json和application/x-www-form-urlencoded,可以通过访问res.body来访问解析对象.</p>
<h1 id="Response-header-fields"><a href="#Response-header-fields" class="headerlink" title="Response header fields"></a>Response header fields</h1><p>res.header包含解析之后的响应头数据,键值都是node处理成小写字母形式，比如res.header[‘content-length’].</p>
<h1 id="Response-Content-Type"><a href="#Response-Content-Type" class="headerlink" title="Response Content-Type"></a>Response Content-Type</h1><p>Content-Type响应头字段是一个特列，服务器提供res.type来访问它，默认res.charset是空的,如果有的话，则自动填充，例如Content-Type值为text/html; charset=utf8,则res.type为text/html,res.charst为utf8.</p>
<h1 id="Response-status"><a href="#Response-status" class="headerlink" title="Response status"></a>Response status</h1><p>响应状态标识可以用来判断请求是否成功，除此之外，可以用superagent来构建理想的restful服务器,这些标识目前定义为:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> type = status / <span class="number">100</span> | <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// status / class</span></span><br><span class="line"> res.status = status;</span><br><span class="line"> res.statusType = type;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// basics</span></span><br><span class="line"> res.info = <span class="number">1</span> == type;</span><br><span class="line"> res.ok = <span class="number">2</span> == type;</span><br><span class="line"> res.clientError = <span class="number">4</span> == type;</span><br><span class="line"> res.serverError = <span class="number">5</span> == type;</span><br><span class="line"> res.error = <span class="number">4</span> == type || <span class="number">5</span> == type;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// sugar</span></span><br><span class="line"> res.accepted = <span class="number">202</span> == status;</span><br><span class="line"> res.noContent = <span class="number">204</span> == status || <span class="number">1223</span> == status;</span><br><span class="line"> res.badRequest = <span class="number">400</span> == status;</span><br><span class="line"> res.unauthorized = <span class="number">401</span> == status;</span><br><span class="line"> res.notAcceptable = <span class="number">406</span> == status;</span><br><span class="line"> res.notFound = <span class="number">404</span> == status;</span><br><span class="line"> res.forbidden = <span class="number">403</span> == status;</span><br></pre></td></tr></table></figure></p>
<h1 id="中止请求"><a href="#中止请求" class="headerlink" title="中止请求"></a>中止请求</h1><p>可以通过req.abort()来中止请求.</p>
<h1 id="请求超时"><a href="#请求超时" class="headerlink" title="请求超时"></a>请求超时</h1><p>可以通过req.timeout()来定义超时时间,然后当超时错误发生时，为了区别于别的错误,err.timeout属性被定义为超时时间,注意,当超时错误发生后，后续的请求都会被重定向.不是每个请求.</p>
<h1 id="基础验证"><a href="#基础验证" class="headerlink" title="基础验证"></a>基础验证</h1><p>nodejs客户端可以通过两种方式来达到验证的目的,第一个是传递一个像这样的url,user:pass:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.get(<span class="string">'http://tobi:learnboost[@local](/user/local)'</span>).end(callback);</span><br></pre></td></tr></table></figure></p>
<p>第二种是调用.auth()方法:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">  .get(<span class="string">'http://local'</span>)</span><br><span class="line">  .auth(<span class="string">'tobo'</span>, <span class="string">'learnboost'</span>)</span><br><span class="line">  .end(callback);</span><br></pre></td></tr></table></figure></p>
<h1 id="跟随重定向"><a href="#跟随重定向" class="headerlink" title="跟随重定向"></a>跟随重定向</h1><p>默认是向上跟随5个重定向，不过可以通过调用.res.redirects(n)来设置个数:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">  .get(<span class="string">'/some.png'</span>)</span><br><span class="line">  .redirects(<span class="number">2</span>)</span><br><span class="line">  .end(callback);</span><br></pre></td></tr></table></figure></p>
<h1 id="管道数据"><a href="#管道数据" class="headerlink" title="管道数据"></a>管道数据</h1><p>nodejs客户端允许使用一个请求流来输送数据,比如请求一个文件作为输出流:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'superagent'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stream = fs.createReadStream(<span class="string">'path/to/my.json'</span>);</span><br><span class="line"><span class="keyword">var</span> req = request.post(<span class="string">'/somewhere'</span>);</span><br><span class="line">req.type(<span class="string">'json'</span>);</span><br><span class="line">stream.pipe(req);</span><br></pre></td></tr></table></figure></p>
<p>或者输送一个响应流到文件中:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'superagent'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stream = fs.createWriteStream(<span class="string">'path/to/my.json'</span>);</span><br><span class="line"><span class="keyword">var</span> req = request.get(<span class="string">'/some.json'</span>);</span><br><span class="line">req.pipe(stream);</span><br></pre></td></tr></table></figure></p>
<h1 id="复合请求"><a href="#复合请求" class="headerlink" title="复合请求"></a>复合请求</h1><p>superagent用来构建复合请求非常不错,提供了低级和高级的api方法.</p>
<p>低级的api是使用多个部分来表现一个文件或者字段，.part()方法返回一个新的部分,提供了跟request本身相似的api方法.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> req = request.post(<span class="string">'/upload'</span>);</span><br><span class="line"></span><br><span class="line">req.part()</span><br><span class="line">   .set(<span class="string">'Content-Type'</span>, <span class="string">'image/png'</span>)</span><br><span class="line">   .set(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment; filename="myimage.png"'</span>)</span><br><span class="line">   .write(<span class="string">'some image data'</span>)</span><br><span class="line">   .write(<span class="string">'some more image data'</span>);</span><br><span class="line"></span><br><span class="line">req.part()</span><br><span class="line">   .set(<span class="string">'Content-Disposition'</span>, <span class="string">'form-data; name="name"'</span>)</span><br><span class="line">   .set(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>)</span><br><span class="line">   .write(<span class="string">'tobi'</span>);</span><br><span class="line"></span><br><span class="line">req.end(callback);</span><br></pre></td></tr></table></figure></p>
<h1 id="附加文件"><a href="#附加文件" class="headerlink" title="附加文件"></a>附加文件</h1><p>上面提及的高级api方法，可以通用.attach(name, [path], [filename])和.field(name, value)这两种形式来调用.添加多个附件也比较简单，只需要给附件提供自定义的文件名称,同样的基础名称也要提供.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">  .post(<span class="string">'/upload'</span>)</span><br><span class="line">  .attach(<span class="string">'avatar'</span>, <span class="string">'path/to/tobi.png'</span>, <span class="string">'user.png'</span>)</span><br><span class="line">  .attach(<span class="string">'image'</span>, <span class="string">'path/to/loki.png'</span>)</span><br><span class="line">  .attach(<span class="string">'file'</span>, <span class="string">'path/to/jane.png'</span>)</span><br><span class="line">  .end(callback);</span><br></pre></td></tr></table></figure></p>
<h1 id="字段值"><a href="#字段值" class="headerlink" title="字段值"></a>字段值</h1><p>跟html的字段很像,你可以调用.field(name,value)方法来设置字段,假设你想上传一个图片的时候带上自己的名称和邮箱，那么你可以像下面写的那样:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">   .post(<span class="string">'/upload'</span>)</span><br><span class="line">   .field(<span class="string">'user[name]'</span>, <span class="string">'Tobi'</span>)</span><br><span class="line">   .field(<span class="string">'user[email]'</span>, <span class="string">'tobi[@learnboost](/user/learnboost).com'</span>)</span><br><span class="line">   .attach(<span class="string">'image'</span>, <span class="string">'path/to/tobi.png'</span>)</span><br><span class="line">   .end(callback);</span><br></pre></td></tr></table></figure>
<h1 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h1><p>nodejs客户端本身就提供了压缩响应内容，所以你不需要做任何其它事情.</p>
<h1 id="缓冲响应"><a href="#缓冲响应" class="headerlink" title="缓冲响应"></a>缓冲响应</h1><p>为了强迫缓冲res.text这样的响应内容,可以调用req.buffer()方法,想取消默认的文本缓冲响应像text/plain,text/html这样的，可以调用req.buffer(false)方法</p>
<p>当缓冲res.buffered标识提供了，那么就可以在一个回调函数里处理缓冲和没缓冲的响应.</p>
<h1 id="跨域资源共享"><a href="#跨域资源共享" class="headerlink" title="跨域资源共享"></a>跨域资源共享</h1><p>.withCredentials()方法可以激活发送原始cookie的能力,不过只有在Access-Control-Allow-Origin不是一个通配符(*),并且Access-Control-Allow-Credentials为’true’的情况下才行.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">  .get(<span class="string">'http://localhost:4001/'</span>)</span><br><span class="line">  .withCredentials()</span><br><span class="line">  .end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    assert(<span class="number">200</span> == res.status);</span><br><span class="line">    assert(<span class="string">'tobi'</span> == res.text);</span><br><span class="line">    next();</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><p>当发送错误时，superagent首先会检查回调函数的参数数量,当err参数提供的话，参数就是两个,如下:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line"> .post(<span class="string">'/upload'</span>)</span><br><span class="line"> .attach(<span class="string">'image'</span>, <span class="string">'path/to/tobi.png'</span>)</span><br><span class="line"> .end(<span class="function"><span class="keyword">function</span>(<span class="params">err, res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>当省略了回调函数,或者回调只有一个参数的话,可以添加error事件的处理.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">  .post(<span class="string">'/upload'</span>)</span><br><span class="line">  .attach(<span class="string">'image'</span>, <span class="string">'path/to/tobi.png'</span>)</span><br><span class="line">  .on(<span class="string">'error'</span>, handle)</span><br><span class="line">  .end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>注意:superagent默认情况下,对响应4xx和5xx的认为不是错误,例如当响应返回一个500或者403的时候,这些状态信息可以通过res.error,res.status和其它的响应属性来查看,但是没有任务的错误对象会传递到回调函数里或者emit一个error事件.正常的error事件只会发生在网络错误,解析错误等.</p>
<p>当产生一个4xx或者5xx的http错误响应,res.error提供了一个错误信息的对象，你可以通过检查这个来做某些事情.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (res.error) &#123;</span><br><span class="line">  alert(<span class="string">'oh no '</span> + res.error.message);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  alert(<span class="string">'got '</span> + res.status + <span class="string">' response'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/21/全面理解-koa-router/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/21/全面理解-koa-router/" itemprop="url">全面理解 koa-router</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-21T15:18:43+08:00">
                2019-02-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/21/全面理解-koa-router/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/21/全面理解-koa-router/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>koa 框架一直都保持着简洁性, 它只对 node 的 HTTP 模块进行了封装, 而在真正实际使用, 我们还需要更多地像路由这样的模块来构建我们的应用, 而 koa-router 是常用的 koa 的路由库. 这里通过解析 koa-router 的源码来达到深入学习的目的.</p>
<h1 id="深入浅出路由模块"><a href="#深入浅出路由模块" class="headerlink" title="深入浅出路由模块"></a>深入浅出路由模块</h1><p>在 node 原生里面, 如果我们需要实现路由功能, 那么就可以像下面这样编写代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; parse &#125; = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; pathname &#125; = parse(req.url);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pathname === <span class="string">'/'</span>) &#123;</span><br><span class="line">        res.end(<span class="string">'index page'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pathname === <span class="string">'/test'</span>) &#123;</span><br><span class="line">        res.end(<span class="string">'test page'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.end(<span class="string">'router is not found'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>上面的代码通过解析原生 request IncomingMessage 的 url 属性, 利用 if…else 判断路径返回不同的结果.<br>但是上面的代码缺点也很明显, 如果路由过多, if…else 的分支也会越庞大, 不利于代码的维护与多人合作.因此,我们需要一个特定的路由模块来统一地模块化地解决路由功能的问题.<br>如果是使用 koa-router 的话, 那么可以借助下面的代码来简单建立一个 koa-router 库的使用 demo:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> KoaRouter = <span class="built_in">require</span>(<span class="string">'koa-router'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="comment">// 创建 router 实例对象</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> KoaRouter();</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册路由</span></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'index'</span>);</span><br><span class="line">  ctx.body = <span class="string">'index'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(router.routes());  <span class="comment">// 添加路由中间件</span></span><br><span class="line">app.use(router.allowedMethods()); <span class="comment">// 对请求进行一些限制处理</span></span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>运行上面的代码, 访问根路由 ‘/‘ 我们可以看到返回数据为 ‘index’, 这说明路由已经基本生效了.<br>我们来看上面的代码, 使用 koa-router 第一步就是新建一个 router 实例对象:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> KoaRouter();</span><br></pre></td></tr></table></figure>
<p>然后在构建应用的时候, 我们的首要目标就是创建多个 CGI 接口以适配不同的业务需求, 那么接下来就需要注册对应的路由:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'index'</span>);</span><br><span class="line">  ctx.body = <span class="string">'index'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面的示例使用了 GET 方法来进行注册根路由, 实际上不仅可以使用 GET 方法, 还可以使用 POST, DELETE, PUT 等等 node 支持的方法.<br>然后为了让 koa 实例使用我们处理后的路由模块, 我们需要使用 routes 方法将路由加入到应用全局的中间件函数中:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.use(router.routes());  <span class="comment">// 添加路由中间件</span></span><br><span class="line">app.use(router.allowedMethods()); <span class="comment">// 对请求进行一些限制处理</span></span><br></pre></td></tr></table></figure>
<h1 id="源码架构与解析"><a href="#源码架构与解析" class="headerlink" title="源码架构与解析"></a>源码架构与解析</h1><p>通过上面的代码, 我们已经知道了 koa-router 的简单使用, 接下来我们需要深入到代码中, 理解它是怎么做到匹配从客户端传过来的请求并跳转执行对应的逻辑的.在此之前我们先看一下代码的结构图:<br><img src="http://weixinfactory.di1game.com/blog/router.png"></p>
<h2 id="Router-amp-Layer"><a href="#Router-amp-Layer" class="headerlink" title="Router &amp; Layer"></a>Router &amp; Layer</h2><p>第一步, 我们需要新建一个 Router 的实例对象, 而对于一个 Router 的实例来说理解其属性是至关重要的.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Router</span>(<span class="params">opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Router)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Router(opts);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.opts = opts || &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.methods = <span class="keyword">this</span>.opts.methods || [</span><br><span class="line">    <span class="string">'HEAD'</span>,</span><br><span class="line">    <span class="string">'OPTIONS'</span>,</span><br><span class="line">    <span class="string">'GET'</span>,</span><br><span class="line">    <span class="string">'PUT'</span>,</span><br><span class="line">    <span class="string">'PATCH'</span>,</span><br><span class="line">    <span class="string">'POST'</span>,</span><br><span class="line">    <span class="string">'DELETE'</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.params = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.stack = [];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以看到, 实际有用的属性不过 3 个, 分别是 methods 数组, params 对象, stack 数组. methods 数组存放的是允许使用的 HTTP 方法名, 会在 Router.prototype.allowedMethods 方法中使用, 我们在创建 Router 实例的时候可以进行配置, 允许使用哪些方法. 而对于 params 对象它存储的是键为参数名与值为对应的参数校验函数, 这样是为了通过在全局存储参数的校验函数, 方便在注册路由的时候为路由的中间件函数数组添加校验函数. 对于 stack 数组, 则是存储每一个路由, 也就是 Layer 的实例对象, 每一个路由都相当于一个 Layer 实例对象.<br>对于 Layer 类来说, 创建一个实例对象用于管理每个路由:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Layer</span>(<span class="params">path, methods, middleware, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.opts = opts || &#123;&#125;;</span><br><span class="line">  <span class="comment">// 路由命名</span></span><br><span class="line">  <span class="keyword">this</span>.name = <span class="keyword">this</span>.opts.name || <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 路由对应的方法</span></span><br><span class="line">  <span class="keyword">this</span>.methods = [];</span><br><span class="line">  <span class="comment">// 路由参数名数组</span></span><br><span class="line">  <span class="keyword">this</span>.paramNames = [];</span><br><span class="line">  <span class="comment">// 路由处理中间件数组</span></span><br><span class="line">  <span class="keyword">this</span>.stack = <span class="built_in">Array</span>.isArray(middleware) ? middleware : [middleware];</span><br><span class="line">  <span class="comment">// 存储路由方法</span></span><br><span class="line">  methods.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> l = <span class="keyword">this</span>.methods.push(method.toUpperCase());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.methods[l<span class="number">-1</span>] === <span class="string">'GET'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.methods.unshift(<span class="string">'HEAD'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将添加的回调处理中间件函数添加到 Layer 实例对象的 stack 数组中</span></span><br><span class="line">  <span class="keyword">this</span>.stack.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> type = (<span class="keyword">typeof</span> fn);</span><br><span class="line">    <span class="keyword">if</span> (type !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        methods.toString() + <span class="string">" `"</span> + (<span class="keyword">this</span>.opts.name || path) +<span class="string">"`: `middleware` "</span></span><br><span class="line">        + <span class="string">"must be a function, not `"</span> + type + <span class="string">"`"</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.path = path;</span><br><span class="line">  <span class="keyword">this</span>.regexp = pathToRegExp(path, <span class="keyword">this</span>.paramNames, <span class="keyword">this</span>.opts);</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'defined route %s %s'</span>, <span class="keyword">this</span>.methods, <span class="keyword">this</span>.opts.prefix + <span class="keyword">this</span>.path);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们可以看到, 对于 Layer 的实例对象, 核心的逻辑还是在于将 path 转化为正则表达式用于匹配请求的路由, 然后将路由的处理中间件添加到 Layer 的 stack 数组中. 注意这里的 stack 和 Router 里面的 stack 是不一样的, Router 的 stack 数组是存放每个路由对应的 Layer 实例对象的, 而 Layer 实例对象里面的 stack 数组是存储每个路由的处理函数中间件的, 换言之, 一个路由可以添加多个处理函数.</p>
<img src="http://weixinfactory.di1game.com/blog/router&layer.png">
<h2 id="method-相关函数"><a href="#method-相关函数" class="headerlink" title="method 相关函数"></a>method 相关函数</h2><p>所谓 method 就是 HTTP 协议中或者说是在 node 中支持的 HTTP 请求方法.其实我们可以通过打印 node 中的 HTTP 的方法来查看 node 支持的 HTTP method:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'http'</span>).METHODS; <span class="comment">// ['ACL', ...., 'GET', 'POST', 'PUT', ...]</span></span><br></pre></td></tr></table></figure>
<p>在 koa-router 里面的体现就是我们可以通过在 router 实例对象上调用对应的方法函数来注册对应的 HTTP 方法的路由而且每个方法的核心逻辑都类似, 就是将传入的路由路径与对应的回调函数绑定, 所以我们可以遍历一个方法数组来快速构建原型的 method 方法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">methods.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">method</span>) </span>&#123;</span><br><span class="line">  Router.prototype[method] = <span class="function"><span class="keyword">function</span> (<span class="params">name, path, middleware</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> middleware;</span><br><span class="line">    <span class="comment">// 判断有没有传入 name 参数, 如果有则处理参数个数问题</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">'string'</span> || path <span class="keyword">instanceof</span> <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">      middleware = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      middleware = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">      path = name;</span><br><span class="line">      name = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注册路由</span></span><br><span class="line">    <span class="keyword">this</span>.register(path, [method], middleware, &#123;</span><br><span class="line">      name: name</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面函数中先判断 path 是否是字符串或者正则表达式是因为注册路由的时候还可以为路由进行命名(命名空间方便管理), 然后准确地获取回调的函数数组(注册路由可以接收多个回调), 这样如果匹配到某个路由, 回调函数数组中的函数就会依次执行. 留意到每个方法都会返回对象本身, 也就是说注册路由的时候是可以支持链式调用的.<br>此外, 我们可以看到, 每个方法的核心其实还是 register 函数, 所以我们下面看看 register 函数的逻辑.</p>
<h2 id="Router-prototype-register"><a href="#Router-prototype-register" class="headerlink" title="Router.prototype.register"></a>Router.prototype.register</h2><p>register 是注册路由的核心函数, 举个例子, 如果我们需要注册一个路径为 ‘/test’ 的接收 GET 方法的路由, 那么:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/test'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>其实它相当于下面这段代码:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.register(<span class="string">'/test'</span>, [<span class="string">'GET'</span>], [<span class="keyword">async</span> (ctx, next) =&gt; &#123;&#125;], &#123; <span class="attr">name</span>: <span class="literal">null</span> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到, 函数将路由作为第一个参数传入, 然后方法名放入到方法数组中作为第二个参数, 第三个函数是路由的回调数组, 其实每个路由注册的时候, 后面都可以添加很多个函数, 而这些函数都会被添加到一个数组里面, 如果被匹配到, 就会利用中间件机制来逐个执行这些函数. 最后一个函数是将路由的命名空间传入.<br>这里避免篇幅过长, 不再陈列 register 函数的代码, 请移步 koa-router 源码仓库关于 register 函数部分 查看.<br>register 函数的逻辑其实也很简单, 因为核心的代码全部都交由 Layer 类去完成了, register 函数只是负责处理 path 如果是数组的话那么需要递归调用 register 函数, 然后新建一个 Layer 类的实例对象, 并且检查在注册这个路由之间有没有注册过 param 路由参数校验函数, 如果有的话, 那么就使用 Layer.prototype.param 函数将校验函数加入到路由的中间件函数数组前面.</p>
<h2 id="Router-prototype-match"><a href="#Router-prototype-match" class="headerlink" title="Router.prototype.match"></a>Router.prototype.match</h2><p>通过上面的模块, 我们已经注册好了路由, 但是, 如果请求过来了, 请求是怎么匹配然后进行到相对应的处理函数去的呢? 答案就是利用 match 函数.先看一下 match 函数的代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Router.prototype.match = <span class="function"><span class="keyword">function</span> (<span class="params">path, method</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 取所有路由 Layer 实例</span></span><br><span class="line">  <span class="keyword">var</span> layers = <span class="keyword">this</span>.stack;</span><br><span class="line">  <span class="keyword">var</span> layer;</span><br><span class="line">  <span class="comment">// 匹配结果</span></span><br><span class="line">  <span class="keyword">var</span> matched = &#123;</span><br><span class="line">    path: [],</span><br><span class="line">    pathAndMethod: [],</span><br><span class="line">    route: <span class="literal">false</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 遍历路由 Router 的 stack 逐个判断</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> len = layers.length, i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    layer = layers[i];</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">'test %s %s'</span>, layer.path, layer.regexp);</span><br><span class="line">    <span class="comment">// 这里是使用由路由字符串生成的正则表达式判断当前路径是否符合该正则</span></span><br><span class="line">    <span class="keyword">if</span> (layer.match(path)) &#123;</span><br><span class="line">      <span class="comment">// 将对应的 Layer 实例加入到结果集的 path 数组中</span></span><br><span class="line">      matched.path.push(layer);</span><br><span class="line">      <span class="comment">// 如果对应的 layer 实例中 methods 数组为空或者数组中有找到对应的方法</span></span><br><span class="line">      <span class="keyword">if</span> (layer.methods.length === <span class="number">0</span> || ~layer.methods.indexOf(method)) &#123;</span><br><span class="line">        <span class="comment">// 将 layer 放入到结果集的 pathAndMethod 中</span></span><br><span class="line">        matched.pathAndMethod.push(layer);</span><br><span class="line">        <span class="comment">// 这里是用于判断是否有真正匹配到路由处理函数</span></span><br><span class="line">        <span class="comment">// 因为像 router.use(session()); 这样的中间件也是通过 Layer 来管理的, 它们的 methods 数组为空</span></span><br><span class="line">        <span class="keyword">if</span> (layer.methods.length) matched.route = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> matched;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过上面返回的结果集, 我们知道一个请求来临的时候, 我们可以使用正则来匹配路由是否符合, 然后在 path 数组或者 pathAndMethod 数组中找到对应的 Layer 实例对象.</p>
<h2 id="Router-prototype-routes-middlewares"><a href="#Router-prototype-routes-middlewares" class="headerlink" title="Router.prototype.routes(middlewares)"></a>Router.prototype.routes(middlewares)</h2><p>如果根据一开始的 demo 例子, 在上面注册好了路由之后, 我们就可以使用 router.routes 来将路由模块添加到 koa 的中间件处理机制当中了. 由于 koa 的中间件插件是以一个函数的形式存在的, 所以 routes 函数返回值就是一个函数:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Router.prototype.routes = Router.prototype.middleware = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> router = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> dispatch = <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  dispatch.router = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dispatch;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们可以看到返回的 dispatch 函数在 routes 内部形成了一个闭包, 并且按照 koa 的中间件形式编写函数.对于 dispatch 函数内部逻辑就如下:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dispatch = <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    debug(<span class="string">'%s %s'</span>, ctx.method, ctx.path);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> path = router.opts.routerPath || ctx.routerPath || ctx.path;</span><br><span class="line">    <span class="comment">// 根据 path 值取的匹配的路由 Layer 实例对象</span></span><br><span class="line">    <span class="keyword">var</span> matched = router.match(path, ctx.method);</span><br><span class="line">    <span class="keyword">var</span> layerChain, layer, i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ctx.matched) &#123;</span><br><span class="line">      ctx.matched.push.apply(ctx.matched, matched.path);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ctx.matched = matched.path;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ctx.router = router;</span><br><span class="line">    <span class="comment">// 如果没有匹配到对应的路由模块, 那么就直接跳过下面的逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (!matched.route) <span class="keyword">return</span> next();</span><br><span class="line">    <span class="comment">// 取路径与方法都匹配了的 Layer 实例对象</span></span><br><span class="line">    <span class="keyword">var</span> matchedLayers = matched.pathAndMethod</span><br><span class="line">    <span class="keyword">var</span> mostSpecificLayer = matchedLayers[matchedLayers.length - <span class="number">1</span>]</span><br><span class="line">    ctx._matchedRoute = mostSpecificLayer.path;</span><br><span class="line">    <span class="keyword">if</span> (mostSpecificLayer.name) &#123;</span><br><span class="line">      ctx._matchedRouteName = mostSpecificLayer.name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建路径对应路由的处理中间件函数数组</span></span><br><span class="line">    <span class="comment">// 这里的目的是在每个匹配的路由对应的中间件处理函数数组前添加一个用于处理</span></span><br><span class="line">    <span class="comment">// 对应路由的 captures, params, 以及路由命名的函数</span></span><br><span class="line">    layerChain = matchedLayers.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">memo, layer</span>) </span>&#123;</span><br><span class="line">      memo.push(<span class="function"><span class="keyword">function</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// captures 是存储路由中参数的值的数组</span></span><br><span class="line">        ctx.captures = layer.captures(path, ctx.captures);</span><br><span class="line">        <span class="comment">// params 是一个对象, 键为参数名, 根据参数名可以获取路由中的参数值, 值从 captures 中拿</span></span><br><span class="line">        ctx.params = layer.params(path, ctx.captures, ctx.params);</span><br><span class="line">        ctx.routerName = layer.name;</span><br><span class="line">        <span class="keyword">return</span> next();</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> memo.concat(layer.stack);</span><br><span class="line">    &#125;, []);</span><br><span class="line">    <span class="comment">// 使用 compose 模块将对应路由的处理中间件数组中的函数逐个执行</span></span><br><span class="line">    <span class="comment">// 当路由的处理函数中间件函数全部执行完, 再调用上一层级的 next 函数进入下一个中间件</span></span><br><span class="line">    <span class="keyword">return</span> compose(layerChain)(ctx, next);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="Router-prototype-allowedMethod"><a href="#Router-prototype-allowedMethod" class="headerlink" title="Router.prototype.allowedMethod"></a>Router.prototype.allowedMethod</h2><p>对于 allowedMethod 方法来说, 它的作用就是用于处理请求的错误, 所以它作为路由模块的最后一个函数来执行.同样地, 它也是以一个 koa 的中间件插件函数的形式出现, 同样在函数内部形成了一个闭包:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Router.prototype.allowedMethods = <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  options = options || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> implemented = <span class="keyword">this</span>.methods;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">allowedMethods</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面的代码很简单, 就是保存 Router 配置中允许的 HTTP 方法数组在闭包内部</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">allowedMethods</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 从这里可以看出, allowedMethods 函数是用于在中间件机制中处理返回结果的函数</span></span><br><span class="line">    <span class="comment">// 先执行 next 函数, next 函数返回的是一个 Promise 对象</span></span><br><span class="line">    <span class="keyword">return</span> next().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> allowed = &#123;&#125;;</span><br><span class="line">      <span class="comment">// allowedMethods 函数的逻辑建立在 statusCode 没有设置或者值为 404 的时候</span></span><br><span class="line">      <span class="keyword">if</span> (!ctx.status || ctx.status === <span class="number">404</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里的 matched 就是在 match 函数执行之后返回结果集中的 path 数组</span></span><br><span class="line">        <span class="comment">// 也就是说请求路径与路由正则匹配的 layer 实例对象数组</span></span><br><span class="line">        ctx.matched.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">route</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// 将这些 layer 路由的 HTTP 方法存储起来</span></span><br><span class="line">          route.methods.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">method</span>) </span>&#123;</span><br><span class="line">            allowed[method] = method;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 将上面的 allowed 整理为数组</span></span><br><span class="line">        <span class="keyword">var</span> allowedArr = <span class="built_in">Object</span>.keys(allowed);</span><br><span class="line">        <span class="comment">// implemented 就是 Router 配置中的 methods 数组, 也就是允许的方法</span></span><br><span class="line">        <span class="comment">// 这里通过 ~ 运算判断当前的请求方法是否在配置允许的方法中</span></span><br><span class="line">        <span class="comment">// 如果该方法不被允许</span></span><br><span class="line">        <span class="keyword">if</span> (!~implemented.indexOf(ctx.method)) &#123;</span><br><span class="line">          <span class="comment">// 如果 Router 配置中配置 throw 为 true</span></span><br><span class="line">          <span class="keyword">if</span> (options.throw) &#123;</span><br><span class="line">            <span class="keyword">var</span> notImplementedThrowable;</span><br><span class="line">            <span class="comment">// 如果配置中规定了 throw 抛出错误的函数, 那么就执行对应的函数</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> options.notImplemented === <span class="string">'function'</span>) &#123;</span><br><span class="line">              notImplementedThrowable = options.notImplemented(); <span class="comment">// set whatever the user returns from their function</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果没有则直接抛出 HTTP Error</span></span><br><span class="line">              notImplementedThrowable = <span class="keyword">new</span> HttpError.NotImplemented();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 抛出错误</span></span><br><span class="line">            <span class="keyword">throw</span> notImplementedThrowable;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Router 配置 throw 为 false</span></span><br><span class="line">            <span class="comment">// 设置状态码为 501</span></span><br><span class="line">            ctx.status = <span class="number">501</span>;</span><br><span class="line">            <span class="comment">// 并且设置 Allow 头部, 值为上面得到的允许的方法数组 allowedArr</span></span><br><span class="line">            ctx.set(<span class="string">'Allow'</span>, allowedArr.join(<span class="string">', '</span>));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (allowedArr.length) &#123;</span><br><span class="line">          <span class="comment">// 来到这里说明该请求的方法是被允许的, 那么为什么会没有状态码 statusCode 或者 statusCode 为 404 呢?</span></span><br><span class="line">          <span class="comment">// 原因在于除却特殊情况, 我们一般在业务逻辑里面不会处理 OPTIONS 请求的</span></span><br><span class="line">          <span class="comment">// 发出这个请求一般常见就是非简单请求, 则会发出预检请求 OPTIONS</span></span><br><span class="line">          <span class="comment">// 例如 application/json 格式的 POST 请求</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 如果是 OPTIONS 请求, 状态码为 200, 然后设置 Allow 头部, 值为允许的方法数组 methods</span></span><br><span class="line">          <span class="keyword">if</span> (ctx.method === <span class="string">'OPTIONS'</span>) &#123;</span><br><span class="line">            ctx.status = <span class="number">200</span>;</span><br><span class="line">            ctx.body = <span class="string">''</span>;</span><br><span class="line">            ctx.set(<span class="string">'Allow'</span>, allowedArr.join(<span class="string">', '</span>));</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!allowed[ctx.method]) &#123;</span><br><span class="line">          <span class="comment">// 方法被服务端允许, 但是在路径匹配的路由中没有找到对应本次请求的方法的处理函数</span></span><br><span class="line">            <span class="comment">// 类似上面的逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (options.throw) &#123;</span><br><span class="line">              <span class="keyword">var</span> notAllowedThrowable;</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">typeof</span> options.methodNotAllowed === <span class="string">'function'</span>) &#123;</span><br><span class="line">                notAllowedThrowable = options.methodNotAllowed(); <span class="comment">// set whatever the user returns from their function</span></span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                notAllowedThrowable = <span class="keyword">new</span> HttpError.MethodNotAllowed();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">throw</span> notAllowedThrowable;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// 这里的状态码为 405</span></span><br><span class="line">              ctx.status = <span class="number">405</span>;</span><br><span class="line">              ctx.set(<span class="string">'Allow'</span>, allowedArr.join(<span class="string">', '</span>));</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>值得注意的是, Router.methods 数组里面的方法是服务端需要实现并支持的方法, 如果客户端发送过来的请求方法不被允许, 那么这是一个服务端错误 501, 但是如果这个方法被允许, 但是找不到对应这个方法的路由处理函数(比如相同路由的 POST 路由但是用 GET 方法来获取数据), 这是一个客户端错误 405.</p>
<h2 id="Router-prototype-use"><a href="#Router-prototype-use" class="headerlink" title="Router.prototype.use"></a>Router.prototype.use</h2><p>use 函数就是用于添加中间件的, 只不过不同于 koa 中的 use 函数, router 的 use 函数添加的中间件函数会在所有路由执行之前执行.此外, 它还可以对某些特定路径的进行中间件函数的绑定执行.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Router.prototype.use = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> router = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 中间件函数数组</span></span><br><span class="line">  <span class="keyword">var</span> middleware = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">  <span class="keyword">var</span> path;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 支持同时为多个路由绑定中间件函数: router.use(['/use', '/admin'], auth());</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(middleware[<span class="number">0</span>]) &amp;&amp; <span class="keyword">typeof</span> middleware[<span class="number">0</span>][<span class="number">0</span>] === <span class="string">'string'</span>) &#123;</span><br><span class="line">    middleware[<span class="number">0</span>].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">p</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 递归调用</span></span><br><span class="line">      router.use.apply(router, [p].concat(middleware.slice(<span class="number">1</span>)));</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 直接返回, 下面是非数组 path 的逻辑</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果第一个参数有传值为字符串, 说明有传路径</span></span><br><span class="line">  <span class="keyword">var</span> hasPath = <span class="keyword">typeof</span> middleware[<span class="number">0</span>] === <span class="string">'string'</span>;</span><br><span class="line">  <span class="keyword">if</span> (hasPath) &#123;</span><br><span class="line">    path = middleware.shift();</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  middleware.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">m</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果有 router 属性, 说明这个中间件函数是由 Router.prototype.routes 暴露出来的</span></span><br><span class="line">    <span class="comment">// 属于嵌套路由</span></span><br><span class="line">    <span class="keyword">if</span> (m.router) &#123;</span><br><span class="line">      <span class="comment">// 这里的逻辑很有意思, 如果是嵌套路由, 相当于将需要嵌套路由重新注册到现在的 Router 对象上</span></span><br><span class="line">      m.router.stack.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">nestedLayer</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 如果有 path, 那么为需要嵌套的路由加上路径前缀</span></span><br><span class="line">        <span class="keyword">if</span> (path) nestedLayer.setPrefix(path);</span><br><span class="line">        <span class="comment">// 如果本身的 router 有前缀配置, 也添加上</span></span><br><span class="line">        <span class="keyword">if</span> (router.opts.prefix) nestedLayer.setPrefix(router.opts.prefix);</span><br><span class="line">        <span class="comment">// 将需要嵌套的路由模块的 stack 中存储的 Layer 加入到本 router 对象上</span></span><br><span class="line">        router.stack.push(nestedLayer);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// 这里与 register 函数的逻辑类似, 注册的时候检查添加参数校验函数 params</span></span><br><span class="line">      <span class="keyword">if</span> (router.params) &#123;</span><br><span class="line">        <span class="built_in">Object</span>.keys(router.params).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">          m.router.param(key, router.params[key]);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 没有 router 属性则是常规中间件函数, 如果有给定的 path 那么就生成一个 Layer 模块进行管理</span></span><br><span class="line">      <span class="comment">// 如果没有 path, 那么就生成通配的路径 (.*) 来生成 Layer 来管理</span></span><br><span class="line">      router.register(path || <span class="string">'(.*)'</span>, [], m, &#123; <span class="attr">end</span>: <span class="literal">false</span>, <span class="attr">ignoreCaptures</span>: !hasPath &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>通过上面我们就清楚, 在 koa-router 里面, 它将所有的路由与所有路由都适用的中间件函数都看做 Layer, 通过 Layer 来处理, 然后将他们的回调函数存储在 Layer 实例本身的 stack 数组中, 然后全局的 router 实例对象的 stack 数组存放所有的 Layer 达到全局管理的目的.</p>
<h1 id="router-处理请求的流程"><a href="#router-处理请求的流程" class="headerlink" title="router 处理请求的流程"></a>router 处理请求的流程</h1><p>上面就是 koa-router 的核心 API, 下面我们通过一张图来总结一下, 看一下当一个请求来临, koa-router 是如何处理的:</p>
<img src="http://weixinfactory.di1game.com/blog/request-process.png">
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="为什么需要在-GET-请求放一个-HEAD-请求"><a href="#为什么需要在-GET-请求放一个-HEAD-请求" class="headerlink" title="为什么需要在 GET 请求放一个 HEAD 请求 ?"></a>为什么需要在 GET 请求放一个 HEAD 请求 ?</h2><p>我们可以看到在 Layer 的构建函数里面, 在对于 methods 的处理中, 会进行判断如果该请求为 GET 请求, 那么就需要在 GET 请求前面添加一个 HEAD 方法, 其原因在于 HEAD 方法与 GET 方法基本是一致的,所以 koa-router 在处理 GET 请求的时候顺带将 HEAD 请求一并处理, 因为两者的区别在于 HEAD 请求不响应数据体.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/21/解析-SMTP-协议/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="胡剑">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuJian's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/21/解析-SMTP-协议/" itemprop="url">解析 SMTP 协议</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-21T15:00:54+08:00">
                2019-02-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/21/解析-SMTP-协议/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/21/解析-SMTP-协议/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SMTP 是属于应用层协议, 是基于 TCP 协议用于收发邮件的.我们常常需要在业务中使用邮件, 但是并没有对 smtp 协议有足够的了解, 我们下面就来全面地了解一下. smtp 服务器一般会开启 25 端口提供服务, 当然如果 smtp 服务器使用了安全认证也就是 ssl/tls, 那么就会开放 465 或 587 端口开放服务, 例如 smtp.qq.com.</p>
<h1 id="SMTP-的工作流程"><a href="#SMTP-的工作流程" class="headerlink" title="SMTP 的工作流程"></a>SMTP 的工作流程</h1><p>相信很多人在使用邮件服务的时候, 特别是在 nodejs 编写中, 都会直接使用像 nodemailer 这样的库来直接编写逻辑, 但这里并不会使用这样的库, 本着学习协议的细节的意思, 我们从零开始编写一个 smtp 客户端,要求客户端可以进行身份验证与发送多格式的邮件.<br>我们在最开始的时候, 需要先使用 socket 来进行 tcp 连接操作, 并且需要注意, 每个信息的末尾都要使用 \r\n 来表示该行信息结束.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Net = <span class="built_in">require</span>(<span class="string">'net'</span>);</span><br><span class="line"><span class="keyword">const</span> socket = <span class="keyword">new</span> Net.Socket();</span><br><span class="line"><span class="keyword">const</span> iconv = <span class="built_in">require</span>(<span class="string">'iconv-lite'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data = [];</span><br><span class="line"><span class="keyword">let</span> size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 监听 data 事件接收服务器信息</span></span><br><span class="line">socket.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">    data.push(chunk);</span><br><span class="line">    size += chunk.length</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 拼接 buffer</span></span><br><span class="line">socket.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> buf = Buffer.concat(data, size);</span><br><span class="line">    <span class="keyword">let</span> message = iconv.decode(buf, <span class="string">'utf8'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(message);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">socket.connect(&#123; host, port &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="HELO-命令"><a href="#HELO-命令" class="headerlink" title="HELO 命令"></a>HELO 命令</h2><p>经过上面的连接操作之后, 我们会收到:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">220 welcome</span><br></pre></td></tr></table></figure>
<p>220 为连接成功状态码, 后面为欢迎信息, 接下来我们就需要向服务器发起一个 HELO 命令, 主要是用于标识客户端自己身份的.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.write(<span class="string">'HELO debugmail.io\r\n'</span>); // debugmail.io 为 smtp 服务器域名</span><br></pre></td></tr></table></figure>
<p>发送了 HELO 命令之后. 会收到 250 状态码, 250 状态码会在后面多次用到, 所以我们使用全局变量来存放一些命令运行后的状态, 比如已经认证了或已经发送了某些命令.</p>
<h2 id="AUTH-LOGIN-命令"><a href="#AUTH-LOGIN-命令" class="headerlink" title="AUTH LOGIN 命令"></a>AUTH LOGIN 命令</h2><p>AUTH LOGIN 命令是用于登录 smtp 服务器的, 在上面接收到 250 状态码之后, 如果没有进行过认证的话,那么我们就需要进行认证操作:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.write(<span class="string">'AUTH LOGIN\r\n'</span>);</span><br></pre></td></tr></table></figure>
<p>发送了 AUTH LOGIN 命令之后, 服务器会发送一个 334 的状态码, 334 的状态码后面跟着的信息是 base64 编码后的 Username: 和 Password:, 第一个是 Username:, 类似这样:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">334 UGFzc3dvcmQ6</span><br></pre></td></tr></table></figure>
<p>这个时候我们接收到 334 状态码与后面的信息之后, 需要先 base64 解码判断是需要输入帐号还是密码, 注意, 如果是需要发送帐号, 那么我们就发送帐号, 格式是 base64 格式化后的字符串:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.write(`<span class="variable">$&#123;new Buffer(username).toString('base64')&#125;</span>\r\n`);</span><br></pre></td></tr></table></figure>
<p>认证成功后, 即帐号密码都正确后, 那么服务器就会返回 235 状态码表示认证信息已经成功.</p>
<h2 id="MAIL-FROM-命令"><a href="#MAIL-FROM-命令" class="headerlink" title="MAIL FROM 命令"></a>MAIL FROM 命令</h2><p>上面的认证信息登录成功后, 我们需要发送 MAIL FROM 命令, 很简单, 就是字面意思理解, 告诉 smtp 服务器此邮件是从那么邮件地址发送, 主要目的是验证该邮箱地址被不被邮件服务器支持.后面只能接一个地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.write(<span class="string">'MAIL FROM: &lt;shawncheung702@gmail.com&gt;'</span>);</span><br></pre></td></tr></table></figure>
<p>注意, 这里的尖括号最好加上, 因为有些 smtp 服务器并不能解析不加尖括号的邮箱地址, 如果不加尖括号有可能会报错</p>
<h2 id="RCPT-TO-命令"><a href="#RCPT-TO-命令" class="headerlink" title="RCPT TO 命令"></a>RCPT TO 命令</h2><p>上面 MAIL FROM 成功后, 我们需要发送 RCPT TO 命令, 很简单, 就是字面意思理解, 告诉 smtp 服务器此邮件的接收地址是哪些, 能不能被邮件服务器支持, 注意, 邮件可能会被群发, 所以 RCPT TO 命令后面可能会有多个邮箱地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.write(<span class="string">'RCPT TO: &lt;shawncheung702@gmail.com&gt;'</span>);</span><br></pre></td></tr></table></figure>
<p>同理, 这里的每个邮箱地址最好加上尖括号.</p>
<h2 id="DATA-命令"><a href="#DATA-命令" class="headerlink" title="DATA 命令"></a>DATA 命令</h2><p>在我们发送真实邮件内容实体之前, 我们需要先发送一个 DATA 命令, 告诉服务器我们接下来需要发送邮件实体数据:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.write(<span class="string">'DATA\r\n'</span>);</span><br></pre></td></tr></table></figure>
<p>发送了 DATA 命令之后, 服务器接收到之后, 会返回一个状态码与信息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">354 Enter mail, end with <span class="string">"."</span> on a line by itself</span><br></pre></td></tr></table></figure>
<p>然后我们接收到 354 状态码之后, 就可以进行实体内容的组装发送了, 注意这里邮件所有实体内容发送完毕之后需要发送一个 . 号来标记数据已全部发送完毕.<br>而这里的数据, 有几个注意的地方:</p>
<p>1,需要指定邮件的 Content-Type, 如果是有附件的, 那么值为 multipart/mixed, 如果没有那么就是 multipart/alternative;<br>2,需要指定一个 boundary 也就是分隔符, 用于分割邮件的各个部分内容, 在每个部分的前后加上.<br>3,from, to 信息是需要加上的, 也即是我们通过邮件客户端看到的邮件头部信息, subject 头部是邮件的标题信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.content);</span><br><span class="line">      <span class="keyword">const</span> mimeVersion = <span class="string">'1.0'</span>;</span><br><span class="line">      <span class="keyword">const</span> boundary = <span class="string">`========<span class="subst">$&#123;(<span class="built_in">Math</span>.random() * <span class="number">10000000000000</span>).toFixed()&#125;</span>==`</span>;</span><br><span class="line">      socket.write(<span class="string">`Content-Type:multipart/mixed;\n boundary="<span class="subst">$&#123;boundary&#125;</span>"<span class="subst">$&#123;msgEnd&#125;</span>`</span>);</span><br><span class="line">      socket.write(<span class="string">`MIME-Version: <span class="subst">$&#123;mimeVersion&#125;</span><span class="subst">$&#123;msgEnd&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">of</span> keys) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'from'</span>: <span class="comment">// 发出地址</span></span><br><span class="line">            socket.write(<span class="string">`From:<span class="subst">$&#123;<span class="keyword">this</span>.content[key]&#125;</span><span class="subst">$&#123;msgEnd&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'to'</span>: <span class="comment">// 发往地址</span></span><br><span class="line">            socket.write(<span class="string">`To:<span class="subst">$&#123;<span class="keyword">this</span>.content[key]&#125;</span><span class="subst">$&#123;msgEnd&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'subject'</span>: <span class="comment">// 标题信息</span></span><br><span class="line">            socket.write(<span class="string">`Subject:<span class="subst">$&#123;<span class="keyword">this</span>.content[key]&#125;</span><span class="subst">$&#123;msgEnd&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'text'</span>: 处理文本信息</span><br><span class="line">            socket.write(<span class="string">`\n--<span class="subst">$&#123;boundary&#125;</span>\n`</span>);</span><br><span class="line">            socket.write(<span class="string">`Content-Type:text/plain; charset="utf-8"\n`</span>);</span><br><span class="line">            socket.write(<span class="string">`MIME-Version:<span class="subst">$&#123;mimeVersion&#125;</span>\n`</span>);</span><br><span class="line">            socket.write(<span class="string">`\n<span class="subst">$&#123;text&#125;</span><span class="subst">$&#123;msgEnd&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'html'</span>: <span class="comment">// 处理 html</span></span><br><span class="line">            socket.write(<span class="string">`\n--<span class="subst">$&#123;boundary&#125;</span>\n`</span>);</span><br><span class="line">            socket.write(<span class="string">`Content-Type:text/html; charset="utf-8"\n`</span>);</span><br><span class="line">            socket.write(<span class="string">`MIME-Version:<span class="subst">$&#123;mimeVersion&#125;</span>\n`</span>);</span><br><span class="line">            socket.write(<span class="string">`\n<span class="subst">$&#123;html&#125;</span><span class="subst">$&#123;msgEnd&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'attachment'</span>: <span class="comment">// 处理附件</span></span><br><span class="line">            <span class="keyword">const</span> filePaths = attachment;</span><br><span class="line">            <span class="keyword">const</span> fileNum = attachment.length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> path <span class="keyword">of</span> filePaths) &#123;</span><br><span class="line">              <span class="keyword">await</span> Mail.handleFile(&#123; path, boundary, mimeVersion &#125;, socket);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 邮件结尾</span></span><br><span class="line">      socket.write(<span class="string">`\n--<span class="subst">$&#123;boundary&#125;</span>--\n<span class="subst">$&#123;msgEnd&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 根据 354 的信息, 需要 . 进行结尾</span></span><br><span class="line">      socket.write(<span class="string">`<span class="subst">$&#123;msgEnd&#125;</span>.<span class="subst">$&#123;msgEnd&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>
<h2 id="QUIT-命令"><a href="#QUIT-命令" class="headerlink" title="QUIT 命令"></a>QUIT 命令</h2><p>在完成上面的步骤之后, 其实一封邮件的发送基本属于完成, 我们现在需要做的就是告诉 smtp 服务器我们的操作已经完成了, 正式结束所有操作, 所以我们需要发送一个结束命令, 也就是 QUIT:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.write(<span class="string">'QUIIT\r\n'</span>);</span><br></pre></td></tr></table></figure>
<p>发送了这个命令之后, 服务器收到该命令之后就会知道操作已经完成了, 那么就会返回一个状态码与信息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">221 Bye</span><br></pre></td></tr></table></figure>
<p>状态码 221 就是结束状态码, Bye 是服务器的结束信息.</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>我下面贴出一个真实的 smtp 客户端与服务器的沟通过程:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">220 smtp.qq.com Esmtp QQ Mail Server</span><br><span class="line"></span><br><span class="line">250 smtp.qq.com // 欢迎信息</span><br><span class="line"></span><br><span class="line">334 VXNlcm5hbWU6  // 认证帐号</span><br><span class="line"></span><br><span class="line">334 UGFzc3dvcmQ6  // 认证密码</span><br><span class="line"></span><br><span class="line">235 Authentication successful  // 登录成功</span><br><span class="line"></span><br><span class="line">250 Ok // mail from 命令成功</span><br><span class="line"></span><br><span class="line">250 Ok // rcpt to 命令成功</span><br><span class="line"></span><br><span class="line">354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt; // data 命令</span><br><span class="line"></span><br><span class="line">250 Ok: queued as // 邮件发送等待中</span><br><span class="line"></span><br><span class="line">221 Bye // smtp 协议沟通结束</span><br></pre></td></tr></table></figure></p>
<h1 id="SMTP-的-MIME-格式"><a href="#SMTP-的-MIME-格式" class="headerlink" title="SMTP 的 MIME 格式"></a>SMTP 的 MIME 格式</h1><p>我们知道, 一封邮件不仅仅是只可以发送文本信息, 它还可以发送 html 信息与附件.先说对于 html 文档,我们需要在局部的地方写上不同的 Content-Type:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--==========boundary==</span><br><span class="line">Content-Type: text/html; charset=<span class="string">"utf-8"</span></span><br><span class="line">MIME-Version: 1.0</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Hello World!&lt;/h1&gt;</span><br><span class="line">--==========boundary==</span><br></pre></td></tr></table></figure>
<p>而对于附件, 我们需要在局部写上 Content-Disposition 头部, 因为我们需要的是附件, 需要可以提供下载, 所以值为 attachment, 并且指定文件名:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--==========boundary==</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line">Content-Transfer-Encoding: base64</span><br><span class="line">Content-Disposition: attachment; filename=<span class="string">"test.md"</span></span><br><span class="line">MIME-Version: 1.0</span><br><span class="line"></span><br><span class="line">VXNlcm5hbWU6</span><br><span class="line">--==========boundary==</span><br></pre></td></tr></table></figure>
<p>注意这里我并没有根据文件名来决定 Content-Type, 而是统一使用 application/octet-stream, 使用流的方式传文件.文件的内容使用 base64 编码, 所以头部需要添加 Content-Transfer-Encoding 来说明编码格式.</p>
<h2 id="邮件中的附件"><a href="#邮件中的附件" class="headerlink" title="邮件中的附件"></a>邮件中的附件</h2><p>邮件中的图片有两种形式, 一种可以使用 img 标签放在邮件体中的 html 内容中, 另一个就是使用附件的形式发送.对于在 html 文档中的, 就是像平时的 img 标签中使用, 而对于附件来说, 我们就可以直接通过 stream 读文件, 然后进行 base64 编码, 将图片放到协议的头部信息里面, 实现附件功能.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars2.githubusercontent.com/u/46552129?s=460&v=4" alt="胡剑">
            
              <p class="site-author-name" itemprop="name">胡剑</p>
              <p class="site-description motion-element" itemprop="description">时间就是一个小偷,它让你猝不及防地失去,那些你很容易忽略掉的东西,当你记起时，却怎么也找不着了...</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/FassbenderMichael" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/540907171/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/df1f61cabea9" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-heartbeat"></i>简书</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.douban.com/people/179974868/" target="_blank" title="豆瓣">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>豆瓣</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">胡剑</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://fassbendermichael.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
